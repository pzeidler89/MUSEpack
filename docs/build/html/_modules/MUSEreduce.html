

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>MUSEreduce &mdash; MUSEpack 1.0.2_legacy documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> MUSEpack
          

          
          </a>

          
            
            
              <div class="version">
                1.0.2 legacy
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">1. Installing MUSEpack</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#additional-python-packages">1.1. Additional python packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#additional-3rd-party-software">1.2. Additional 3rd party software</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../MUSEreduce.html">2. MUSEreduce</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../MUSEreduce.html#the-basic-folder-structure">2.1. The basic folder structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../MUSEreduce.html#the-config-file">2.2. The config file</a></li>
<li class="toctree-l2"><a class="reference internal" href="../MUSEreduce.html#utility-methods">2.3. Utility methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../MUSEreduce.html#history">2.4. History</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../radialvelocities.html">3. Spectral line fitting and radial velocity measurements</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../radialvelocities.html#spectral-line-fitter">3.1. Spectral line fitter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../radialvelocities.html#id2">3.2. Radial Velocities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../radialvelocities.html#the-radial-velocity-fitter">3.2.1. The radial velocity fitter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../radialvelocities.html#monte-carlo-radial-velocity-determination">3.2.2. Monte Carlo radial velocity determination</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../radialvelocities.html#history">3.3. History</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cubes.html">4. Cubes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../cubes.html#history">4.1. History</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../utilities.html">5. Utility module</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../utilities.html#history">5.1. History</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">6. Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#measuring-stellar-radial-velocities">6.1. Measuring stellar radial velocities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#the-procedure">6.1.1. The procedure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples.html#the-results">6.1.2. The results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html#additional-tutorials">6.2. Additional tutorials</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Credits:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../credits.html">Credits</a></li>
</ul>
<p class="caption"><span class="caption-text">Disclaimer:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../disclaimer.html">Disclaimer</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MUSEpack</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>MUSEreduce</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for MUSEreduce</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;1.0.2&#39;</span>

<span class="n">__revision__</span> <span class="o">=</span> <span class="s1">&#39;20200129&#39;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">filecmp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">ascii</span><span class="p">,</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>


<div class="viewcode-block" id="musereduce"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce.musereduce">[docs]</a><span class="k">class</span> <span class="nc">musereduce</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Kwargs:</span>
<span class="sd">        configfile : :obj:`str`</span>
<span class="sd">            A :obj:`json` configfile for musereduce, where all the parameters</span>
<span class="sd">            are set.</span>

<span class="sd">        debug : :obj:`bool`, (optional), default: :obj:`None`</span>
<span class="sd">            :obj:`True`: :class:`MUSEreduce.musereduce` runs in debug mode and</span>
<span class="sd">            ESORex will not be executed. All products must be available.</span>
<span class="sd">            It can be used for testing the creation of folder, and creating</span>
<span class="sd">            the ``.sof`` files</span>

<span class="sd">    &#39;&#39;&#39;</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configfile</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">configfile</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">configfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/config.json&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">configfile</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">read_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">read_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">][</span><span class="s1">&#39;withrvcorr&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OB_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">][</span><span class="s1">&#39;OB_list&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dithername</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">][</span><span class="s1">&#39;OB&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dithering_multiple_OBs</span> <span class="o">=</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">][</span><span class="s1">&#39;dither_multiple_OBs&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithering_multiple_OBs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OB_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">dithername</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">][</span><span class="s1">&#39;rootpath&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">][</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto__sort_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">][</span><span class="s1">&#39;auto_sort_data&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">using_specific_exposure_time</span> <span class="o">=</span>\
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">][</span><span class="s1">&#39;using_specific_exposure_time&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_CPU</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">][</span><span class="s1">&#39;n_CPU&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">using_ESO_calibration</span> <span class="o">=</span>\
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;calibration&#39;</span><span class="p">][</span><span class="s1">&#39;using_ESO_calibration&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;calibration&#39;</span><span class="p">][</span><span class="s1">&#39;dark&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renew_statics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;calibration&#39;</span><span class="p">][</span><span class="s1">&#39;renew_statics&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">skyreject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sci_basic&#39;</span><span class="p">][</span><span class="s1">&#39;skyreject&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;skylines&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sci_basic&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skylines</span> <span class="o">=</span> <span class="s1">&#39;5577.339,6300.304&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skylines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sci_basic&#39;</span><span class="p">][</span><span class="s1">&#39;skylines&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;execute_std&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sci_basic&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reduce_std</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reduce_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sci_basic&#39;</span><span class="p">][</span><span class="s1">&#39;execute_std&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">skyfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sky&#39;</span><span class="p">][</span><span class="s1">&#39;sky_field&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skyfraction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sky&#39;</span><span class="p">][</span><span class="s1">&#39;fraction&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skyignore</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sky&#39;</span><span class="p">][</span><span class="s1">&#39;ignore&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skymethod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sky&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sci_post&#39;</span><span class="p">][</span><span class="s1">&#39;subtract_sky&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raman</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sci_post&#39;</span><span class="p">][</span><span class="s1">&#39;raman&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;NFM-AO&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">raman</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exp_combine&#39;</span><span class="p">][</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_list</span> <span class="o">=</span>\
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dither_collect&#39;</span><span class="p">][</span><span class="s1">&#39;user_list&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>

<div class="viewcode-block" id="musereduce.execute"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce.musereduce.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This method executes wrapper and starts the data reduction process</span>
<span class="sd">        set in the :obj:`json` config file.</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">startime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;##############################################################&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#####                                                    #####&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#####        MUSE data reduction pipeline wrapper        #####&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#####   Must be used with ESORex and ESO MUSE pipeline   #####&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#####      author: Peter Zeidler (zeidler@stsci.edu)     #####&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#####                    Jan 29, 2020                    #####&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#####                   Version: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">__version__</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;   </span><span class="se">\</span>
<span class="s1">                #####&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#####                                                    #####&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;##############################################################&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Checking various necessary variables&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;YOU ARE NOT USING PYTHON 3.x&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">][</span><span class="s1">&#39;pipeline_path&#39;</span><span class="p">],</span>\
            <span class="s1">&#39;NO PIPELINE PATH DEFINED&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">][</span><span class="s1">&#39;rootpath&#39;</span><span class="p">],</span> <span class="s1">&#39;NO ROOTPATH DEFINED&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">][</span><span class="s1">&#39;OB&#39;</span><span class="p">],</span> <span class="s1">&#39;NO OBs given&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithering_multiple_OBs</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Currently a user list cannot be provided with multiple OBs&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Perfect, everything checks out&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Settings for data reduction&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;##################################################&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#####        RUNNING IN DEBUG MODE           #####&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#####      PRODUCTS MUST BE ALL THERE        #####&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#####          NO ESORex EXECUTION           #####&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;##################################################&#39;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; Number of cores: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_CPU</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; cores&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; bariocentric correction: on&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyfield</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; Skyfield: &quot;automatic&quot; &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyfield</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; Skyfield: &quot;science exposure&quot; &#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; bariocentric correction: off&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; sky subtraction: off&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; Observation mode: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;calibration&#39;</span><span class="p">][</span><span class="s1">&#39;execute&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ESO_calibration</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; Using ESO calibration files&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; Using self-processed calibration files&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; DARK will be reduced and used&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; DARK will not be reduced and used&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; DARK will be used: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raman</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; Removal of Raman lines: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raman</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithering_multiple_OBs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; Exposures per pointing are spread over multiple OBs&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;==&gt; The pointing name is: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithername</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">multOB_exp_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; All exposures are located in one OB&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; Dithering exposures input list:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">li</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">li</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OB_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; Reducing more than one OB: &#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OB_list</span><span class="p">)))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... The following modules will be executed&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;calibration&#39;</span><span class="p">][</span><span class="s1">&#39;execute&#39;</span><span class="p">]</span>\
        <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ESO_calibration</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; BIAS&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; DARK&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; FLAT&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; WAVECAL&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; LSF&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; TWILIGHT&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sci_basic&#39;</span><span class="p">][</span><span class="s1">&#39;execute&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; SCIBASIC&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_std</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Caution SCIBASIC will not be executed on STD star!!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;std_flux&#39;</span><span class="p">][</span><span class="s1">&#39;execute&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; STANDARD&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sky&#39;</span><span class="p">][</span><span class="s1">&#39;execute&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; CREATE_SKY&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sci_post&#39;</span><span class="p">][</span><span class="s1">&#39;execute&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; SCI_POST&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exp_combine&#39;</span><span class="p">][</span><span class="s1">&#39;execute&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; EXP_ALIGN&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; EXP_COMBINE&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;#####  All parameters set: Starting the data reduction   #####&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">OB</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">OB_list</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Creating directories&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; for OB: &#39;</span> <span class="o">+</span> <span class="n">OB</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithering_multiple_OBs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span> <span class="o">+</span> <span class="s1">&#39;raw/&#39;</span> <span class="o">+</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">dithername</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">OB</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span> <span class="o">+</span> <span class="s1">&#39;reduced/&#39;</span>\
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithername</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">OB</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span> <span class="o">+</span> <span class="s1">&#39;reduced/&#39;</span>\
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithername</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span> <span class="o">+</span> <span class="s1">&#39;raw/&#39;</span> <span class="o">+</span> <span class="n">OB</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span> <span class="o">+</span> <span class="s1">&#39;reduced/&#39;</span> <span class="o">+</span> <span class="n">OB</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;calibrations/&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;ESO_calibrations/&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;static_calibration_files/&#39;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">renew_statics</span> <span class="ow">and</span>\
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">renew_statics</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span> <span class="o">+</span> <span class="s1">&#39;reduced/&#39;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span> <span class="o">+</span> <span class="s1">&#39;reduced/&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/&#39;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/&#39;</span><span class="p">)</span>\
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/&#39;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/&#39;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">itername</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;global&#39;</span><span class="p">][</span><span class="s1">&#39;pipeline_path&#39;</span><span class="p">]</span>\
            <span class="o">+</span> <span class="s1">&#39;calib/muse*/cal/*.*&#39;</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">itername</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Sorting the data&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto__sort_data</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; Sorting the raw data&#39;</span><span class="p">)</span>
                <span class="n">_sort_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; MANUAL INTERACTION NEEDED&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_specific_exposure_time</span><span class="p">:</span>
                <span class="n">exp_list_SCI</span> <span class="o">=</span>\
                <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;*_SCI.list&#39;</span><span class="p">),</span>\
                <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;*_SKY.list&#39;</span><span class="p">)])</span>
                <span class="n">exp_list_SCI</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)</span>

                <span class="n">exp_list_DAR</span> <span class="o">=</span>\
                <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;*_DAR.list&#39;</span><span class="p">))</span>

                <span class="n">exp_list_TWI</span> <span class="o">=</span>\
                <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;*_TWI.list&#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_specific_exposure_time</span><span class="p">:</span>

                <span class="n">exp_list_SCI</span> <span class="o">=</span>\
                <span class="nb">sorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span>\
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:04d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">using_specific_exposure_time</span><span class="p">))</span> <span class="o">+</span>\
                <span class="s1">&#39;*_SCI.list&#39;</span><span class="p">),</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span>\
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:04d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">using_specific_exposure_time</span><span class="p">))</span>\
                <span class="o">+</span> <span class="s1">&#39;*_SKY.list&#39;</span><span class="p">)]))</span>

                <span class="n">exp_list_DAR</span> <span class="o">=</span>\
                <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span>\
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:04d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">using_specific_exposure_time</span><span class="p">))</span>\
                <span class="o">+</span> <span class="s1">&#39;*_DAR.list&#39;</span><span class="p">))</span>

                <span class="n">exp_list_TWI</span> <span class="o">=</span>\
                <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span>\
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:04d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">using_specific_exposure_time</span><span class="p">))</span>\
                <span class="o">+</span> <span class="s1">&#39;*_TWI.list&#39;</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">exposure</span> <span class="ow">in</span> <span class="n">exp_list_SCI</span><span class="p">:</span>
                <span class="n">exposure_dir</span> <span class="o">=</span> <span class="n">exposure</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exposure_dir</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exposure_dir</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... reducing OB: &#39;</span> <span class="o">+</span> <span class="n">OB</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

            <span class="c1">### CALIBRATION PRE-PROCESSING ###</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;calibration&#39;</span><span class="p">][</span><span class="s1">&#39;execute&#39;</span><span class="p">]:</span>
                <span class="n">create_sof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;calibration&#39;</span><span class="p">][</span><span class="s1">&#39;create_sof&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ESO_calibration</span><span class="p">:</span>
                    <span class="n">_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">exp_list_DAR</span><span class="p">,</span>\
                    <span class="n">exp_list_TWI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                        <span class="n">_dark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">exp_list_DAR</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">)</span>
                    <span class="n">_flat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">exp_list_TWI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">)</span>
                    <span class="n">_wavecal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">exp_list_TWI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">)</span>
                    <span class="n">_lsf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">exp_list_TWI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">)</span>
                    <span class="n">_twilight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">exp_list_TWI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">)</span>

            <span class="c1">### OBSERVATION PRE-PROCESSING ###</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sci_basic&#39;</span><span class="p">][</span><span class="s1">&#39;execute&#39;</span><span class="p">]:</span>
                <span class="n">create_sof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sci_basic&#39;</span><span class="p">][</span><span class="s1">&#39;create_sof&#39;</span><span class="p">]</span>
                <span class="n">_science_pre</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">)</span>

            <span class="c1">### OBSERVATION POST-PROCESSING ###</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;std_flux&#39;</span><span class="p">][</span><span class="s1">&#39;execute&#39;</span><span class="p">]:</span>
                <span class="n">create_sof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;std_flux&#39;</span><span class="p">][</span><span class="s1">&#39;create_sof&#39;</span><span class="p">]</span>
                <span class="n">_std_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sky&#39;</span><span class="p">][</span><span class="s1">&#39;execute&#39;</span><span class="p">]:</span>
                <span class="n">create_sof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sky&#39;</span><span class="p">][</span><span class="s1">&#39;create_sof&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sky&#39;</span><span class="p">][</span><span class="s1">&#39;modified&#39;</span><span class="p">]:</span>
                    <span class="n">_sky</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sky&#39;</span><span class="p">][</span><span class="s1">&#39;modified&#39;</span><span class="p">]:</span>
                    <span class="n">_modified_sky</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">)</span>

            <span class="c1">###s SCIENCE POST-PROCESSING ###</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sci_post&#39;</span><span class="p">][</span><span class="s1">&#39;execute&#39;</span><span class="p">]:</span>
                <span class="n">create_sof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sci_post&#39;</span><span class="p">][</span><span class="s1">&#39;create_sof&#39;</span><span class="p">]</span>
                <span class="n">_scipost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">,</span> <span class="n">OB</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dither_collect&#39;</span><span class="p">][</span><span class="s1">&#39;execute&#39;</span><span class="p">]:</span>
                <span class="n">_dither_collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">OB</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exp_align&#39;</span><span class="p">][</span><span class="s1">&#39;execute&#39;</span><span class="p">]:</span>
            <span class="n">create_sof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exp_align&#39;</span><span class="p">][</span><span class="s1">&#39;create_sof&#39;</span><span class="p">]</span>
            <span class="n">_exp_align</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">,</span> <span class="n">OB</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exp_combine&#39;</span><span class="p">][</span><span class="s1">&#39;execute&#39;</span><span class="p">]:</span>
            <span class="n">create_sof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exp_combine&#39;</span><span class="p">][</span><span class="s1">&#39;create_sof&#39;</span><span class="p">]</span>
            <span class="n">_exp_combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">)</span>

        <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; Total execution time: &#39;</span><span class="p">,</span>\
        <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">endtime</span> <span class="o">-</span> <span class="n">startime</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="_get_filelist"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce._get_filelist">[docs]</a><span class="k">def</span> <span class="nf">_get_filelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">filename_wildcard</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This module collects the necessary file lists from folders.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_dir : :obj:`str`</span>
<span class="sd">            The directory where the files are located.</span>

<span class="sd">        filename_wildcard : :obj:`str`</span>
<span class="sd">            The filenames which should be collected</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
    <span class="n">raw_data_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">filename_wildcard</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">raw_data_list</span></div>


<div class="viewcode-block" id="_call_esorex"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce._call_esorex">[docs]</a><span class="k">def</span> <span class="nf">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exec_dir</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This module calls the various ESOrex commands and gives it to the</span>
<span class="sd">    terminal for execution.</span>

<span class="sd">    Args:</span>
<span class="sd">        exec_dir : :obj:`str`</span>
<span class="sd">            The directory where ESOrex should be executed.</span>

<span class="sd">        esorex_cmd : :obj:`str`</span>
<span class="sd">            The ESOrex command that needs to be executed</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">exec_dir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;export OMP_NUM_THREADS=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_CPU</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;esorex &#39;</span> <span class="o">+</span> <span class="n">esorex_cmd</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;esorex &#39;</span> <span class="o">+</span> <span class="n">esorex_cmd</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span><span class="p">)</span></div>


<div class="viewcode-block" id="_sort_data"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce._sort_data">[docs]</a><span class="k">def</span> <span class="nf">_sort_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This module reads the headers of all of the raw data and sorts it</span>
<span class="sd">    accordingly. It also assigns the correct calibration files to the exposures</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">file_list</span> <span class="o">=</span> <span class="n">_get_filelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span><span class="p">,</span> <span class="s1">&#39;*.fits*&#39;</span><span class="p">)</span>
    <span class="n">science_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">calibration_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">science_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">calibration_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">ESO_calibration_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">ESO_calibration_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

    <span class="n">cal_categories</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;MASTER_BIAS&#39;</span><span class="p">,</span> <span class="s1">&#39;MASTER_DARK&#39;</span><span class="p">,</span> <span class="s1">&#39;MASTER_FLAT&#39;</span><span class="p">,</span>\
    <span class="s1">&#39;TRACE_TABLE&#39;</span><span class="p">,</span> <span class="s1">&#39;WAVECAL_TABLE&#39;</span><span class="p">,</span> <span class="s1">&#39;LSF_PROFILE&#39;</span><span class="p">,</span> <span class="s1">&#39;TWILIGHT_CUBE&#39;</span><span class="p">,</span>\
    <span class="s1">&#39;FILTER_LIST&#39;</span><span class="p">,</span> <span class="s1">&#39;EXTINCT_TABLE&#39;</span><span class="p">,</span> <span class="s1">&#39;STD_FLUX_TABLE&#39;</span><span class="p">,</span> <span class="s1">&#39;SKY_LINES&#39;</span><span class="p">,</span>\
    <span class="s1">&#39;GEOMETRY_TABLE&#39;</span><span class="p">,</span> <span class="s1">&#39;ASTROMETRY_WCS&#39;</span><span class="p">,</span> <span class="s1">&#39;STD_RESPONSE&#39;</span><span class="p">,</span> <span class="s1">&#39;STD_TELLURIC&#39;</span><span class="p">,</span>\
    <span class="s1">&#39;ASTROMETRY_REFERENCE&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>

        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span> <span class="o">+</span> <span class="n">files</span><span class="p">)</span>

        <span class="n">dprcatg_exist</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HIERARCH ESO DPR CATG&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">procatg_exist</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HIERARCH ESO PRO CATG&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dprcatg_exist</span><span class="p">:</span>
            <span class="n">dprcatg</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH ESO DPR CATG&#39;</span><span class="p">])</span>
            <span class="n">dprtype</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH ESO DPR TYPE&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">dprcatg</span> <span class="o">==</span> <span class="s1">&#39;SCIENCE&#39;</span><span class="p">:</span>
                <span class="n">science_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">science_files</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
                <span class="n">science_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">science_type</span><span class="p">,</span> <span class="n">dprtype</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">dprcatg</span> <span class="o">==</span> <span class="s1">&#39;CALIB&#39;</span><span class="p">:</span>
                <span class="n">calibration_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calibration_files</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dprtype</span> <span class="o">==</span> <span class="s1">&#39;FLAT,LAMP&#39;</span><span class="p">:</span>
                    <span class="n">calibration_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calibration_type</span><span class="p">,</span> <span class="s1">&#39;FLAT&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dprtype</span> <span class="o">==</span> <span class="s1">&#39;FLAT,SKY&#39;</span><span class="p">:</span>
                    <span class="n">calibration_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calibration_type</span><span class="p">,</span> <span class="s1">&#39;SKYFLAT&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dprtype</span> <span class="o">==</span> <span class="s1">&#39;WAVE&#39;</span><span class="p">:</span>
                    <span class="n">calibration_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calibration_type</span><span class="p">,</span> <span class="s1">&#39;ARC&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dprtype</span> <span class="o">==</span> <span class="s1">&#39;WAVE,MASK&#39;</span><span class="p">:</span>
                    <span class="n">calibration_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calibration_type</span><span class="p">,</span> <span class="s1">&#39;MASK&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">dprtype</span> <span class="o">==</span> <span class="s1">&#39;FLAT,LAMP,ILLUM&#39;</span><span class="p">:</span>
                    <span class="n">calibration_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calibration_type</span><span class="p">,</span> <span class="s1">&#39;ILLUM&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">calibration_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calibration_type</span><span class="p">,</span> <span class="n">dprtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">procatg_exist</span><span class="p">:</span>
            <span class="n">procatg</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH ESO PRO CATG&#39;</span><span class="p">])</span>
            <span class="n">ESO_calibration_files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ESO_calibration_files</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">cal_category</span> <span class="ow">in</span> <span class="n">cal_categories</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">procatg</span> <span class="o">==</span> <span class="n">cal_category</span><span class="p">:</span>
                    <span class="n">ESO_calibration_type</span> <span class="o">=</span>\
                    <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ESO_calibration_type</span><span class="p">,</span> <span class="n">cal_category</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span>\
                    <span class="o">+</span> <span class="n">cal_category</span><span class="p">):</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span> <span class="o">+</span> <span class="n">files</span><span class="p">,</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span> <span class="o">+</span> <span class="n">cal_category</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>

    <span class="n">rot_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">science_files</span><span class="p">))</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">science_files</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    <span class="n">rot_angles_ident</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">science_files</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">sci_file_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">science_files</span><span class="p">)):</span>

        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span> <span class="o">+</span> <span class="n">science_files</span><span class="p">[</span><span class="n">sci_file_idx</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">RA</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span>
        <span class="n">DEC</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span>
        <span class="n">EXPTIME</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span>

        <span class="n">points</span><span class="p">[</span><span class="n">sci_file_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">RA</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">DEC</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>\
        <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;fk5&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="s1">&#39;hmsdms&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>\
        <span class="n">precision</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">maketrans</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">.</span><span class="n">whitespace</span><span class="p">))</span>\
        <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">EXPTIME</span><span class="p">))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>

        <span class="n">rot_angles</span><span class="p">[</span><span class="n">sci_file_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH ESO INS DROT POSANG&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rot_angles</span><span class="p">)):</span>
        <span class="n">ident</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">idx2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rot_angles</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">rot_angles</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">rot_angles</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span>\
            <span class="ow">and</span> <span class="n">points</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">points</span><span class="p">[</span><span class="n">idx2</span><span class="p">]:</span>
                <span class="n">rot_angles_ident</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ident</span>
                <span class="n">ident</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">sci_file_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">science_files</span><span class="p">)):</span>

        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span> <span class="o">+</span> <span class="n">science_files</span><span class="p">[</span><span class="n">sci_file_idx</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">RA</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span>
        <span class="n">DEC</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span>
        <span class="n">EXPTIME</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXPTIME&#39;</span><span class="p">]</span>
        <span class="n">ROT</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;HIERARCH ESO INS DROT POSANG&#39;</span><span class="p">]</span>
        <span class="n">DATE</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">]</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">RA</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">DEC</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span>\
        <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;fk5&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="s1">&#39;hmsdms&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>\
        <span class="n">precision</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">maketrans</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">.</span><span class="n">whitespace</span><span class="p">))</span>

        <span class="n">filelist_science</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">EXPTIME</span><span class="p">))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>\
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ROT</span><span class="p">))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>\
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rot_angles_ident</span><span class="p">[</span><span class="n">sci_file_idx</span><span class="p">]))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>\
        <span class="o">+</span> <span class="s1">&#39;_SCI.list&#39;</span>

        <span class="n">filelist_sky</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">EXPTIME</span><span class="p">))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>\
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ROT</span><span class="p">))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>\
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rot_angles_ident</span><span class="p">[</span><span class="n">sci_file_idx</span><span class="p">]))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_SKY.list&#39;</span>

        <span class="n">filelist_dark</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">EXPTIME</span><span class="p">))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>\
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ROT</span><span class="p">))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>\
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rot_angles_ident</span><span class="p">[</span><span class="n">sci_file_idx</span><span class="p">]))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_DAR.list&#39;</span>

        <span class="n">filelist_twilight</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">EXPTIME</span><span class="p">))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>\
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ROT</span><span class="p">))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>\
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rot_angles_ident</span><span class="p">[</span><span class="n">sci_file_idx</span><span class="p">]))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_TWI.list&#39;</span>

        <span class="n">dark_date</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">twilight_date</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="k">for</span> <span class="n">calibfiles</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">calibration_files</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">calibration_type</span><span class="p">[</span><span class="n">calibfiles</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DARK&#39;</span><span class="p">:</span>
                <span class="n">hdu_temp</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span>\
                <span class="o">+</span> <span class="n">calibration_files</span><span class="p">[</span><span class="n">calibfiles</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">temp_date</span> <span class="o">=</span> <span class="n">hdu_temp</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">]</span>
                <span class="n">dark_date</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dark_date</span><span class="p">,</span> <span class="n">temp_date</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">calibration_type</span><span class="p">[</span><span class="n">calibfiles</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SKYFLAT&#39;</span><span class="p">:</span>
                <span class="n">hdu_temp</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span>\
                <span class="o">+</span> <span class="n">calibration_files</span><span class="p">[</span><span class="n">calibfiles</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">temp_date</span> <span class="o">=</span> <span class="n">hdu_temp</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">]</span>
                <span class="n">twilight_date</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">twilight_date</span><span class="p">,</span> <span class="n">temp_date</span><span class="p">)</span>

        <span class="n">dark_date</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dark_date</span><span class="p">)</span>
        <span class="n">twilight_date</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">twilight_date</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">science_type</span><span class="p">[</span><span class="n">sci_file_idx</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OBJECT&#39;</span><span class="p">:</span>
            <span class="n">f_science</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="n">filelist_science</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">science_type</span><span class="p">[</span><span class="n">sci_file_idx</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SKY&#39;</span><span class="p">:</span>
            <span class="n">f_science</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="n">filelist_sky</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="n">f_dark</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="n">filelist_dark</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f_twilight</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="n">filelist_twilight</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f_science</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span> <span class="o">+</span> <span class="n">science_files</span><span class="p">[</span><span class="n">sci_file_idx</span><span class="p">]</span>\
        <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">science_type</span><span class="p">[</span><span class="n">sci_file_idx</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">calibfiles</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">calibration_files</span><span class="p">)):</span>
            <span class="n">temp_date</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span>\
            <span class="o">+</span> <span class="n">calibration_files</span><span class="p">[</span><span class="n">calibfiles</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">temp_date</span> <span class="o">-</span> <span class="n">DATE</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">:</span>
                <span class="n">f_science</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span>\
                <span class="o">+</span> <span class="n">calibration_files</span><span class="p">[</span><span class="n">calibfiles</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span>\
                <span class="n">calibration_type</span><span class="p">[</span><span class="n">calibfiles</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">calibration_type</span><span class="p">[</span><span class="n">calibfiles</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;STD&#39;</span>\
            <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">temp_date</span> <span class="o">-</span> <span class="n">DATE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>

                <span class="n">f_science</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span>\
                <span class="o">+</span> <span class="n">calibration_files</span><span class="p">[</span><span class="n">calibfiles</span><span class="p">]</span>\
                <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">calibration_type</span><span class="p">[</span><span class="n">calibfiles</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">calibration_type</span><span class="p">[</span><span class="n">calibfiles</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ILLUM&#39;</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">temp_date</span>\
                <span class="o">-</span> <span class="n">DATE</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
                    <span class="n">f_science</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span>\
                    <span class="o">+</span> <span class="n">calibration_files</span><span class="p">[</span><span class="n">calibfiles</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span>\
                    <span class="o">+</span> <span class="n">calibration_type</span><span class="p">[</span><span class="n">calibfiles</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: STD and SCI obs more than 24 hours apart&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">temp_date</span> <span class="o">-</span> <span class="n">dark_date</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">f_dark</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span>\
                    <span class="o">+</span> <span class="n">calibration_files</span><span class="p">[</span><span class="n">calibfiles</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">calibration_type</span><span class="p">[</span><span class="n">calibfiles</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">temp_date</span> <span class="o">-</span> <span class="n">twilight_date</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">f_twilight</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span>\
                    <span class="o">+</span> <span class="n">calibration_files</span><span class="p">[</span><span class="n">calibfiles</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">calibration_type</span><span class="p">[</span><span class="n">calibfiles</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">f_science</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">f_dark</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">f_twilight</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="_bias"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce._bias">[docs]</a><span class="k">def</span> <span class="nf">_bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">exp_list_DAR</span><span class="p">,</span> <span class="n">exp_list_TWI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This module calls *ESORex&#39;* ``muse_bias``</span>

<span class="sd">    Args:</span>
<span class="sd">        exp_list_SCI : :obj:`list`</span>
<span class="sd">            The list of all associated science files including their category</span>
<span class="sd">            read from the fits header</span>

<span class="sd">        exp_list_DAR : :obj:`list`:</span>
<span class="sd">            The list of all associated dark files including their category read</span>
<span class="sd">            from the fits header</span>

<span class="sd">        exp_list_TWI : :obj:`list`:</span>
<span class="sd">            The list of all associated twilight files including their category</span>
<span class="sd">            read from the fits header </span>

<span class="sd">        create_sof : :obj:`bool`:</span>
<span class="sd">            :obj:`True`: ``bias.sof`` is created and populated</span>

<span class="sd">            :obj:`False`: ``bias.sof`` is not created and needs to be provided</span>
<span class="sd">            by the user</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Creating the MASTER BIAS&#39;</span><span class="p">)</span>

    <span class="n">esorex_cmd</span> <span class="o">=</span> <span class="s1">&#39;--log-file=bias.log --log-level=debug </span><span class="se">\</span>
<span class="s1">    muse_bias --nifu=-1 --merge bias.sof&#39;</span>

    <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/bias.sof&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/bias.sof&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
        <span class="o">+</span> <span class="s1">&#39;DARK/bias.sof&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/bias.sof&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/bias.sof&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/bias.sof&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">exposure_ID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)):</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing exposure: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exposure_ID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>\
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing: &#39;</span> <span class="o">+</span> <span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

            <span class="n">raw_data_list</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">],</span>\
                <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;no_header&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                <span class="n">raw_data_list_DARK</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">exp_list_DAR</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">],</span>\
                <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;no_header&#39;</span><span class="p">)</span>
            <span class="n">raw_data_list_TWILIGHT</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">exp_list_TWI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">],</span>\
                <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;no_header&#39;</span><span class="p">)</span>

            <span class="n">f_science</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span>\
            <span class="s1">&#39;SCIENCE/bias_temp.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])):</span>
                <span class="k">if</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;BIAS&#39;</span><span class="p">:</span>
                    <span class="n">f_science</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span>\
                    <span class="o">+</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f_science</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                <span class="n">f_dark</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>
                                <span class="o">+</span> <span class="s1">&#39;DARK/bias_temp.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data_list_DARK</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])):</span>
                    <span class="k">if</span> <span class="n">raw_data_list_DARK</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;BIAS&#39;</span><span class="p">:</span>
                        <span class="n">f_dark</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_data_list_DARK</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span>\
                        <span class="o">+</span> <span class="n">raw_data_list_DARK</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f_dark</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">f_twilight</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;TWILIGHT/bias_temp.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])):</span>
                <span class="k">if</span> <span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;BIAS&#39;</span><span class="p">:</span>
                    <span class="n">f_twilight</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span>\
                    <span class="o">+</span> <span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f_twilight</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/bias.sof&#39;</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/bias.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/bias_temp.sof&#39;</span><span class="p">),</span>\
                <span class="s1">&#39;CAUTION CALIBRATION FILES ARE DIFFERENT: PLEASE CHECK&#39;</span>

                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/bias_temp.sof&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/bias_temp.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/bias.sof&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/&#39;</span><span class="p">,</span>\
                    <span class="n">esorex_cmd</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/bias.sof&#39;</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/bias.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/bias_temp.sof&#39;</span><span class="p">),</span>\
                <span class="s1">&#39;CAUTION TWILIGHT FILES ARE DIFFERENT: PLEASE CHECK&#39;</span>

                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/bias_temp.sof&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/bias_temp.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/bias.sof&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/&#39;</span><span class="p">,</span>\
                    <span class="n">esorex_cmd</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/bias.sof&#39;</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/bias.sof&#39;</span><span class="p">,</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/bias_temp.sof&#39;</span><span class="p">),</span>\
                    <span class="s1">&#39;CAUTION DARK FILES ARE DIFFERENT: PLEASE CHECK&#39;</span>

                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/bias_temp.sof&#39;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/bias_temp.sof&#39;</span><span class="p">,</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/bias.sof&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/&#39;</span><span class="p">,</span>
                        <span class="n">esorex_cmd</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">create_sof</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/&#39;</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">)</span>
            <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/&#39;</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/&#39;</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">)</span></div>


<div class="viewcode-block" id="_dark"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce._dark">[docs]</a><span class="k">def</span> <span class="nf">_dark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">exp_list_DAR</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This module calls *ESORex&#39;* ``muse_dark``</span>

<span class="sd">    Args:</span>
<span class="sd">        exp_list_SCI : :obj:`list`</span>
<span class="sd">            The list of all associated science files including their category</span>
<span class="sd">            read from the fits header</span>

<span class="sd">        exp_list_DAR : :obj:`list`:</span>
<span class="sd">            The list of all associated dark files including their category read</span>
<span class="sd">            from the fits header</span>

<span class="sd">        create_sof : :obj:`bool`:</span>
<span class="sd">            :obj:`True`: ``bias.sof`` is created and populated</span>

<span class="sd">            :obj:`False`: ``bias.sof`` is not created and needs to be provided</span>
<span class="sd">            by the user</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Creating the MASTER DARK&#39;</span><span class="p">)</span>

    <span class="n">esorex_cmd</span> <span class="o">=</span> <span class="s1">&#39;--log-file=dark.log --log-level=debug </span><span class="se">\</span>
<span class="s1">    muse_dark --nifu=-1 --merge dark.sof&#39;</span>

    <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/dark.sof&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/dark.sof&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">exposure_ID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing exposure: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exposure_ID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>\
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing: &#39;</span> <span class="o">+</span> <span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

            <span class="n">raw_data_list</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">exp_list_DAR</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">],</span>\
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;no_header&#39;</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/dark_temp.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])):</span>
                <span class="k">if</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DARK&#39;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span>\
                    <span class="o">+</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/MASTER_BIAS.fits </span><span class="se">\</span>
<span class="s1">            MASTER_BIAS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/dark.sof&#39;</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/dark.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/dark_temp.sof&#39;</span><span class="p">),</span>\
                <span class="s1">&#39;CAUTION DARK FILES ARE DIFFERENT: PLEASE CHECK&#39;</span>

                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/dark_temp.sof&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/dark_temp.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/dark.sof&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/&#39;</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">create_sof</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;DARK/&#39;</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">)</span></div>


<div class="viewcode-block" id="_flat"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce._flat">[docs]</a><span class="k">def</span> <span class="nf">_flat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">exp_list_TWI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This module calls *ESORex&#39;* ``muse_flat``</span>

<span class="sd">    Args:</span>
<span class="sd">        exp_list_SCI : :obj:`list`</span>
<span class="sd">            The list of all associated science files including their category</span>
<span class="sd">            read from the fits header</span>

<span class="sd">        exp_list_TWI : :obj:`list`:</span>
<span class="sd">            The list of all associated twilight files including their category</span>
<span class="sd">            read from the fits header </span>

<span class="sd">        create_sof : :obj:`bool`:</span>
<span class="sd">            :obj:`True`: ``bias.sof`` is created and populated</span>

<span class="sd">            :obj:`False`: ``bias.sof`` is not created and needs to be provided</span>
<span class="sd">            by the user</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Creating the MASTER FLAT&#39;</span><span class="p">)</span>

    <span class="n">esorex_cmd</span> <span class="o">=</span> <span class="s1">&#39;--log-file=flat.log --log-level=debug muse_flat </span><span class="se">\</span>
<span class="s1">    --samples=true --nifu=-1 --merge flat.sof&#39;</span>

    <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/flat.sof&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/flat.sof&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/flat.sof&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/flat.sof&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">exposure_ID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing exposure: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exposure_ID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>\
            <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing: &#39;</span> <span class="o">+</span> <span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

            <span class="n">raw_data_list</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">],</span>\
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;no_header&#39;</span><span class="p">)</span>
            <span class="n">raw_data_list_TWILIGHT</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">exp_list_TWI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">],</span>\
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;no_header&#39;</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/flat_temp.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])):</span>
                <span class="k">if</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FLAT&#39;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;SCIENCE/MASTER_BIAS.fits MASTER_BIAS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;DARK/MASTER_DARK.fits MASTER_DARK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/flat.sof&#39;</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/flat.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/flat_temp.sof&#39;</span><span class="p">),</span>\
                <span class="s1">&#39;CAUTION SCIENCE FILES ARE DIFFERENT: PLEASE CHECK&#39;</span>

                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/flat_temp.sof&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/flat_temp.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/flat.sof&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/&#39;</span><span class="p">,</span>\
                    <span class="n">esorex_cmd</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/flat_temp.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])):</span>
                <span class="k">if</span> <span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FLAT&#39;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;TWILIGHT/MASTER_BIAS.fits MASTER_BIAS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;DARK/MASTER_DARK.fits MASTER_DARK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/flat.sof&#39;</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/flat.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/flat_temp.sof&#39;</span><span class="p">),</span>\
                <span class="s1">&#39;CAUTION TWILIGHT FILES ARE DIFFERENT: PLEASE CHECK&#39;</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/flat_temp.sof&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/flat_temp.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/flat.sof&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/&#39;</span><span class="p">,</span>\
                    <span class="n">esorex_cmd</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">create_sof</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/&#39;</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">)</span>
            <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/&#39;</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">)</span></div>


<div class="viewcode-block" id="_wavecal"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce._wavecal">[docs]</a><span class="k">def</span> <span class="nf">_wavecal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">exp_list_TWI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This module calls *ESORex&#39;* ``muse_wavecal``</span>

<span class="sd">    Args:</span>
<span class="sd">        exp_list_SCI : :obj:`list`</span>
<span class="sd">            The list of all associated science files including their category</span>
<span class="sd">            read from the fits header</span>

<span class="sd">        exp_list_TWI : :obj:`list`:</span>
<span class="sd">            The list of all associated twilight files including their category</span>
<span class="sd">            read from the fits header </span>

<span class="sd">        create_sof : :obj:`bool`:</span>
<span class="sd">            :obj:`True`: ``bias.sof`` is created and populated</span>

<span class="sd">            :obj:`False`: ``bias.sof`` is not created and needs to be provided</span>
<span class="sd">            by the user</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Creating the WAVELENGTH CALIBRATION&#39;</span><span class="p">)</span>

    <span class="n">esorex_cmd</span> <span class="o">=</span> <span class="s1">&#39;--log-file=wavecal.log --log-level=debug</span><span class="se">\</span>
<span class="s1">    muse_wavecal --nifu=-1 --residuals --merge wavecal.sof&#39;</span>

    <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/wavecal.sof&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/wavecal.sof&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/wavecal.sof&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/wavecal.sof&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">exposure_ID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing exposure: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exposure_ID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>\
            <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing: &#39;</span> <span class="o">+</span> <span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

            <span class="n">raw_data_list</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">],</span>\
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;no_header&#39;</span><span class="p">)</span>
            <span class="n">raw_data_list_TWILIGHT</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">exp_list_TWI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">],</span>\
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;no_header&#39;</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/wavecal_temp.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])):</span>
                <span class="k">if</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ARC&#39;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;line_catalog.fits LINE_CATALOG</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;SCIENCE/MASTER_BIAS.fits MASTER_BIAS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;SCIENCE/TRACE_TABLE.fits TRACE_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;DARK/MASTER_DARK.fits MASTER_DARK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/wavecal.sof&#39;</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;SCIENCE/wavecal.sof&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;SCIENCE/wavecal_temp.sof&#39;</span><span class="p">),</span>\
                <span class="s1">&#39;CAUTION SCIENCE FILES ARE DIFFERENT: PLEASE CHECK&#39;</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/wavecal_temp.sof&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/wavecal_temp.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/wavecal.sof&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/&#39;</span><span class="p">,</span>\
                    <span class="n">esorex_cmd</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/wavecal_temp.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])):</span>
                <span class="k">if</span> <span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ARC&#39;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;line_catalog.fits LINE_CATALOG</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;TWILIGHT/MASTER_BIAS.fits MASTER_BIAS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;TWILIGHT/TRACE_TABLE.fits TRACE_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;DARK/MASTER_DARK.fits MASTER_DARK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/wavecal.sof&#39;</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;TWILIGHT/wavecal.sof&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;TWILIGHT/wavecal_temp.sof&#39;</span><span class="p">),</span>\
                <span class="s1">&#39;CAUTION TWILIGHT FILES ARE DIFFERENT: PLEASE CHECK&#39;</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/wavecal_temp.sof&#39;</span><span class="p">)</span>


            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/wavecal_temp.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/wavecal.sof&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/&#39;</span><span class="p">,</span>\
                    <span class="n">esorex_cmd</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">create_sof</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/&#39;</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">)</span>
            <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/&#39;</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">)</span></div>


<div class="viewcode-block" id="_lsf"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce._lsf">[docs]</a><span class="k">def</span> <span class="nf">_lsf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">exp_list_TWI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This module calls *ESORex&#39;* ``muse_lsf``</span>

<span class="sd">    Args:</span>
<span class="sd">        exp_list_SCI : :obj:`list`</span>
<span class="sd">            The list of all associated science files including their category</span>
<span class="sd">            read from the fits header</span>

<span class="sd">        exp_list_TWI : :obj:`list`:</span>
<span class="sd">            The list of all associated twilight files including their category</span>
<span class="sd">            read from the fits header </span>

<span class="sd">        create_sof : :obj:`bool`:</span>
<span class="sd">            :obj:`True`: ``bias.sof`` is created and populated</span>

<span class="sd">            :obj:`False`: ``bias.sof`` is not created and needs to be provided</span>
<span class="sd">            by the user</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Creating the LINE SPREAD FUNCTION&#39;</span><span class="p">)</span>

    <span class="n">esorex_cmd</span> <span class="o">=</span> <span class="s1">&#39;--log-file=lsf.log --log-level=debug muse_lsf </span><span class="se">\</span>
<span class="s1">    --nifu=-1 --merge --save_subtracted lsf.sof&#39;</span>

    <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/lsf.sof&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/lsf.sof&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/lsf.sof&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/lsf.sof&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">exposure_ID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing exposure: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exposure_ID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>\
            <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing: &#39;</span> <span class="o">+</span> <span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

            <span class="n">raw_data_list</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">],</span>\
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;no_header&#39;</span><span class="p">)</span>
            <span class="n">raw_data_list_TWILIGHT</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">exp_list_TWI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">],</span>\
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;no_header&#39;</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/lsf_temp.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])):</span>
                <span class="k">if</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ARC&#39;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;line_catalog.fits LINE_CATALOG</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;SCIENCE/MASTER_BIAS.fits MASTER_BIAS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;SCIENCE/TRACE_TABLE.fits TRACE_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;SCIENCE/WAVECAL_TABLE.fits WAVECAL_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;DARK/MASTER_DARK.fits MASTER_DARK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;SCIENCE/MASTER_FLAT.fits MASTER_FLAT</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/lsf.sof&#39;</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/lsf.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/lsf_temp.sof&#39;</span><span class="p">),</span>\
                <span class="s1">&#39;CAUTION SCIENCE FILES ARE DIFFERENT: PLEASE CHECK&#39;</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/lsf_temp.sof&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/lsf_temp.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/lsf.sof&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/&#39;</span><span class="p">,</span>\
                    <span class="n">esorex_cmd</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/lsf_temp.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])):</span>
                <span class="k">if</span> <span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ARC&#39;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;line_catalog.fits LINE_CATALOG</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;TWILIGHT/MASTER_BIAS.fits MASTER_BIAS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;TWILIGHT/TRACE_TABLE.fits TRACE_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;TWILIGHT/WAVECAL_TABLE.fits WAVECAL_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;DARK/MASTER_DARK.fits MASTER_DARK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;TWILIGHT/MASTER_FLAT.fits MASTER_FLAT</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/lsf.sof&#39;</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/lsf.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/lsf_temp.sof&#39;</span><span class="p">),</span>\
                <span class="s1">&#39;CAUTION TWILIGHT FILES ARE DIFFERENT: PLEASE CHECK&#39;</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/lsf_temp.sof&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/lsf_temp.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/lsf.sof&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/&#39;</span><span class="p">,</span>\
                    <span class="n">esorex_cmd</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">create_sof</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;SCIENCE/&#39;</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">)</span>
            <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/&#39;</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">)</span></div>


<div class="viewcode-block" id="_twilight"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce._twilight">[docs]</a><span class="k">def</span> <span class="nf">_twilight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">exp_list_TWI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This module calls *ESORex&#39;* ``muse_twilight``</span>

<span class="sd">    Args:</span>
<span class="sd">        exp_list_SCI : :obj:`list`</span>
<span class="sd">            The list of all associated science files including their category</span>
<span class="sd">            read from the fits header</span>

<span class="sd">        exp_list_TWI : :obj:`list`:</span>
<span class="sd">            The list of all associated twilight files including their category</span>
<span class="sd">            read from the fits header </span>

<span class="sd">        create_sof : :obj:`bool`:</span>
<span class="sd">            :obj:`True`: ``bias.sof`` is created and populated</span>

<span class="sd">            :obj:`False`: ``bias.sof`` is not created and needs to be provided</span>
<span class="sd">            by the user</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Creating the TWILIGHT FLAT&#39;</span><span class="p">)</span>

    <span class="n">esorex_cmd</span> <span class="o">=</span> <span class="s1">&#39;--log-file=twilight.log --log-level=debug </span><span class="se">\</span>
<span class="s1">    muse_twilight twilight.sof&#39;</span>

    <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/twilight.sof&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/twilight.sof&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">exposure_ID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing exposure: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exposure_ID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>\
            <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing: &#39;</span> <span class="o">+</span> <span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

            <span class="n">raw_data_list</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">],</span>\
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;no_header&#39;</span><span class="p">)</span>
            <span class="n">raw_data_list_TWILIGHT</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">exp_list_TWI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">],</span>\
            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;no_header&#39;</span><span class="p">)</span>

            <span class="n">MJDsillum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">MJDsskyflat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">illum_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])):</span>
                <span class="k">if</span> <span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SKYFLAT&#39;</span><span class="p">:</span>
                    <span class="n">skyflathdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">MJDskyflat</span> <span class="o">=</span> <span class="n">skyflathdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">]</span>
                    <span class="n">MJDsskyflat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MJDsskyflat</span><span class="p">,</span> <span class="n">MJDskyflat</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ILLUM&#39;</span><span class="p">:</span>
                    <span class="n">illumhdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">MJDillum</span> <span class="o">=</span> <span class="n">illumhdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">]</span>
                    <span class="n">MJDsillum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MJDsillum</span><span class="p">,</span> <span class="n">MJDillum</span><span class="p">)</span>
                    <span class="n">illum_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">illum_index</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

            <span class="n">choosen_illum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">illum_index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">MJDsillum</span>\
            <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">MJDskyflat</span><span class="p">)))])</span>

            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/twilight_temp.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])):</span>
                <span class="k">if</span> <span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SKYFLAT&#39;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">choosen_illum</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>\
            <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">raw_data_list_TWILIGHT</span><span class="p">[</span><span class="n">choosen_illum</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;WFM-AO&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;WFM-NOAO&#39;</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;geometry_table_wfm.fits GEOMETRY_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;NFM-AO&#39;</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;geometry_table_wfm.fits GEOMETRY_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;TWILIGHT/MASTER_BIAS.fits MASTER_BIAS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;TWILIGHT/MASTER_FLAT.fits MASTER_FLAT</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposure_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;DARK/MASTER_DARK.fits MASTER_DARK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;TWILIGHT/TRACE_TABLE.fits TRACE_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;TWILIGHT/WAVECAL_TABLE.fits WAVECAL_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">MJDsskyflat</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">57823.5</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;vignetting_mask.fits VIGNETTING_MASK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/twilight.sof&#39;</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;TWILIGHT/twilight.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/twilight_temp.sof&#39;</span><span class="p">),</span>\
                <span class="s1">&#39;CAUTION TWILIGHT FILES ARE DIFFERENT: PLEASE CHECK&#39;</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/twilight_temp.sof&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/twilight_temp.sof&#39;</span><span class="p">,</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT/twilight.sof&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT&#39;</span><span class="p">,</span>\
                    <span class="n">esorex_cmd</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">create_sof</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span> <span class="s1">&#39;TWILIGHT&#39;</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">)</span></div>


<div class="viewcode-block" id="_science_pre"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce._science_pre">[docs]</a><span class="k">def</span> <span class="nf">_science_pre</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This module calls *ESORex&#39;* ``muse_scibasic``</span>

<span class="sd">    Args:</span>
<span class="sd">        exp_list_SCI : :obj:`list`</span>
<span class="sd">            The list of all associated science files including their category</span>
<span class="sd">            read from the fits header</span>

<span class="sd">        create_sof : :obj:`bool`:</span>
<span class="sd">            :obj:`True`: ``bias.sof`` is created and populated</span>

<span class="sd">            :obj:`False`: ``bias.sof`` is not created and needs to be provided</span>
<span class="sd">            by the user</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... Science PREPROCESSING&#39;</span><span class="p">)</span>

    <span class="n">esorex_cmd</span> <span class="o">=</span> <span class="s1">&#39;--log-file=sci_basic_object.log --log-level=debug </span><span class="se">\</span>
<span class="s1">    muse_scibasic --nifu=-1 --resample --saveimage=true </span><span class="se">\</span>
<span class="s1">    --skyreject=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyreject</span> <span class="o">+</span> <span class="s1">&#39; --skylines=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">skylines</span> \
    <span class="o">+</span> <span class="s1">&#39; --merge  sci_basic_object.sof&#39;</span>
    <span class="n">esorex_cmd_std</span> <span class="o">=</span> <span class="s1">&#39;--log-file=sci_basic_std.log --log-level=debug </span><span class="se">\</span>
<span class="s1">    muse_scibasic --nifu=-1 --resample --saveimage=true --skyreject=15.,15.,1 </span><span class="se">\</span>
<span class="s1">    --merge  sci_basic_std.sof&#39;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/sci_basic_std.sof&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/sci_basic_std.sof&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">exposure_ID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing exposure: &#39;</span>\
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exposure_ID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing: &#39;</span> <span class="o">+</span> <span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="n">raw_data_list</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">],</span>\
        <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;no_header&#39;</span><span class="p">)</span>
        <span class="n">exposure_dir</span> <span class="o">=</span> <span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>

        <span class="n">MJDsillum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">illum_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])):</span>
            <span class="k">if</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OBJECT&#39;</span> <span class="ow">or</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SKY&#39;</span><span class="p">:</span>
                <span class="n">objecthdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">MJDobject</span> <span class="o">=</span> <span class="n">objecthdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;STD&#39;</span><span class="p">:</span>
                <span class="n">stdhdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">MJDstd</span> <span class="o">=</span> <span class="n">stdhdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ILLUM&#39;</span><span class="p">:</span>
                <span class="n">illumhdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">MJDillum</span> <span class="o">=</span> <span class="n">illumhdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">]</span>
                <span class="n">MJDsillum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MJDsillum</span><span class="p">,</span> <span class="n">MJDillum</span><span class="p">)</span>
                <span class="n">illum_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">illum_index</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="n">choosen_illum_object</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">illum_index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">MJDsillum</span>\
        <span class="o">-</span> <span class="n">MJDobject</span><span class="p">))])</span>
        <span class="n">choosen_illum_std</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">illum_index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">MJDsillum</span>\
        <span class="o">-</span> <span class="n">MJDstd</span><span class="p">))])</span>

        <span class="n">f_std</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/sci_basic_std_temp.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])):</span>
            <span class="k">if</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;STD&#39;</span><span class="p">:</span>
                <span class="n">f_std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>\
                <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">f_std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="n">choosen_illum_std</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>\
        <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">choosen_illum_std</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ESO_calibration</span><span class="p">:</span>
            <span class="n">f_std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;SCIENCE/MASTER_BIAS.fits MASTER_BIAS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f_std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;SCIENCE/MASTER_FLAT.fits MASTER_FLAT</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f_std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;TWILIGHT/TWILIGHT_CUBE.fits TWILIGHT_CUBE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f_std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;SCIENCE/TRACE_TABLE.fits TRACE_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f_std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;SCIENCE/WAVECAL_TABLE.fits WAVECAL_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                <span class="n">f_std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;DARK/MASTER_DARK.fits MASTER_DARK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ESO_calibration</span><span class="p">:</span>
            <span class="n">f_std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;MASTER_BIAS.fits MASTER_BIAS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f_std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;MASTER_FLAT.fits MASTER_FLAT</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f_std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;TWILIGHT_CUBE.fits TWILIGHT_CUBE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f_std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;TRACE_TABLE.fits TRACE_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f_std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;WAVECAL_TABLE.fits WAVECAL_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                <span class="n">f_std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;MASTER_DARK.fits MASTER_DARK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;WFM-AO&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;WFM-NOAO&#39;</span><span class="p">:</span>
            <span class="n">f_std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;geometry_table_wfm.fits GEOMETRY_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;NFM-AO&#39;</span><span class="p">:</span>
            <span class="n">f_std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;geometry_table_wfm.fits GEOMETRY_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">f_std</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
        <span class="o">+</span> <span class="s1">&#39;badpix_table.fits BADPIX_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f_std</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;sci_basic_object.sof&#39;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;sci_basic_object.sof&#39;</span><span class="p">)</span>
            <span class="n">f_object</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;sci_basic_object.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][:])):</span>
                <span class="k">if</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OBJECT&#39;</span><span class="p">:</span>
                    <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SKY&#39;</span><span class="p">:</span>
                    <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">raw_data_list</span><span class="p">[</span><span class="n">choosen_illum_object</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>\
            <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">raw_data_list</span><span class="p">[</span><span class="n">choosen_illum_object</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ESO_calibration</span><span class="p">:</span>
                <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;SCIENCE/MASTER_BIAS.fits MASTER_BIAS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;SCIENCE/MASTER_FLAT.fits MASTER_FLAT</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;TWILIGHT/TWILIGHT_CUBE.fits TWILIGHT_CUBE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;SCIENCE/TRACE_TABLE.fits TRACE_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;SCIENCE/WAVECAL_TABLE.fits WAVECAL_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                    <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                    <span class="o">+</span> <span class="s1">&#39;DARK/MASTER_DARK.fits MASTER_DARK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ESO_calibration</span><span class="p">:</span>
                <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;MASTER_BIAS.fits MASTER_BIAS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;MASTER_FLAT.fits MASTER_FLAT</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;TWILIGHT_CUBE.fits TWILIGHT_CUBE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;TRACE_TABLE.fits TRACE_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;WAVECAL_TABLE.fits WAVECAL_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark</span><span class="p">:</span>
                    <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span>\
                    <span class="o">+</span> <span class="s1">&#39;MASTER_DARK.fits MASTER_DARK</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;WFM-AO&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;WFM-NOAO&#39;</span><span class="p">:</span>
                <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;geometry_table_wfm.fits GEOMETRY_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;NFM-AO&#39;</span><span class="p">:</span>
                <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;geometry_table_wfm.fits GEOMETRY_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f_object</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;badpix_table.fits BADPIX_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exposure_dir</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/sci_basic_std.sof&#39;</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/sci_basic_std.sof&#39;</span><span class="p">,</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/sci_basic_std_temp.sof&#39;</span><span class="p">),</span>\
            <span class="s1">&#39;CAUTION DIFFERENT STD STARS FOR VARIOUS FIELDS: PLEASE CHECK&#39;</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/sci_basic_std_temp.sof&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/sci_basic_std_temp.sof&#39;</span><span class="p">,</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/sci_basic_std.sof&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_std</span><span class="p">:</span>
            <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/&#39;</span><span class="p">,</span> <span class="n">esorex_cmd_std</span><span class="p">)</span></div>


<div class="viewcode-block" id="_std_flux"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce._std_flux">[docs]</a><span class="k">def</span> <span class="nf">_std_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This module calls *ESORex&#39;* ``muse_standard``</span>

<span class="sd">    Args:</span>
<span class="sd">        exp_list_SCI : :obj:`list`</span>
<span class="sd">            The list of all associated science files including their category</span>
<span class="sd">            read from the fits header</span>

<span class="sd">        create_sof : :obj:`bool`:</span>
<span class="sd">            :obj:`True`: ``bias.sof`` is created and populated</span>

<span class="sd">            :obj:`False`: ``bias.sof`` is not created and needs to be provided</span>
<span class="sd">            by the user</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... FLUX CALIBRATION&#39;</span><span class="p">)</span>

    <span class="n">esorex_cmd</span> <span class="o">=</span> <span class="s1">&#39; --log-file=std_flux.log --log-level=debug </span><span class="se">\</span>
<span class="s1">    muse_standard --filter=white std_flux.sof&#39;</span>
    <span class="n">PIXTABLE_STD_list</span> <span class="o">=</span> <span class="n">_get_filelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/&#39;</span><span class="p">,</span>\
    <span class="s1">&#39;PIXTABLE_STD*.fits&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/&#39;</span> <span class="o">+</span> <span class="s1">&#39;std_flux.sof&#39;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/&#39;</span> <span class="o">+</span> <span class="s1">&#39;std_flux.sof&#39;</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/&#39;</span> <span class="o">+</span> <span class="s1">&#39;std_flux.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">PIXTABLE_STD_list</span><span class="p">)):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/&#39;</span> <span class="o">+</span> <span class="n">PIXTABLE_STD_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>\
            <span class="o">+</span> <span class="s1">&#39; PIXTABLE_STD</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>
        <span class="o">+</span> <span class="s1">&#39;extinct_table.fits EXTINCT_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
        <span class="o">+</span> <span class="s1">&#39;std_flux_table.fits STD_FLUX_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
        <span class="o">+</span> <span class="s1">&#39;filter_list.fits FILTER_LIST</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
        <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="s1">&#39;std/&#39;</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">)</span></div>


<div class="viewcode-block" id="_sky"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce._sky">[docs]</a><span class="k">def</span> <span class="nf">_sky</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This module calls *ESORex&#39;* ``muse_sky``</span>

<span class="sd">    Args:</span>
<span class="sd">        exp_list_SCI : :obj:`list`</span>
<span class="sd">            The list of all associated science files including their category</span>
<span class="sd">            read from the fits header</span>

<span class="sd">        create_sof : :obj:`bool`:</span>
<span class="sd">            :obj:`True`: ``bias.sof`` is created and populated</span>

<span class="sd">            :obj:`False`: ``bias.sof`` is not created and needs to be provided</span>
<span class="sd">            by the user</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... SKY CREATION&#39;</span><span class="p">)</span>

    <span class="n">sky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">sci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">exposure</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exposure</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SKY&#39;</span><span class="p">:</span> <span class="n">sky</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">exposure</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SCI&#39;</span><span class="p">:</span> <span class="n">sci</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyfield</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sky</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">exp_list_SCI_sky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)[</span><span class="n">sky</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exp_list_SCI_sky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">exposure_ID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI_sky</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing exposure: &#39;</span>\
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exposure_ID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI_sky</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing: &#39;</span> <span class="o">+</span> <span class="n">exp_list_SCI_sky</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="n">raw_data_list</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">exp_list_SCI_sky</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">],</span>\
        <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;no_header&#39;</span><span class="p">)</span>
        <span class="n">exposure_dir</span> <span class="o">=</span> <span class="n">exp_list_SCI_sky</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyfield</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sky</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">PIXTABLE_SKY_list</span> <span class="o">=</span>\
            <span class="n">_get_filelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exposure_dir</span><span class="p">,</span> <span class="s1">&#39;PIXTABLE_SKY*.fits&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">PIXTABLE_SKY_list</span> <span class="o">=</span>\
            <span class="n">_get_filelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exposure_dir</span><span class="p">,</span> <span class="s1">&#39;PIXTABLE_OBJECT*.fits&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;sky.sof&#39;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;sky.sof&#39;</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;sky.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">PIXTABLE_SKY_list</span><span class="p">)):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">exposure_dir</span> <span class="o">+</span> <span class="n">PIXTABLE_SKY_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>\
                <span class="o">+</span> <span class="s1">&#39; PIXTABLE_SKY</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ESO_calibration</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span> <span class="o">+</span>\
                <span class="s1">&#39;SCIENCE/LSF_PROFILE.fits LSF_PROFILE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ESO_calibration</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span> <span class="o">+</span>\
                <span class="s1">&#39;LSF_PROFILE.fits LSF_PROFILE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;std/&#39;</span> <span class="o">+</span> <span class="s1">&#39;STD_RESPONSE_0001.fits STD_RESPONSE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;std/&#39;</span> <span class="o">+</span> <span class="s1">&#39;STD_TELLURIC_0001.fits STD_TELLURIC</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;extinct_table.fits EXTINCT_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;sky_lines.fits SKY_LINES</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">esorex_cmd</span> <span class="o">=</span> <span class="s2">&quot;--log-file=sky.log --log-level=debug </span><span class="se">\</span>
<span class="s2">        muse_create_sky --fraction=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyfraction</span><span class="p">)</span>\
        <span class="o">+</span> <span class="s2">&quot; --ignore=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyignore</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; sky.sof&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyfield</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sky</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exposure_dir</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exposure_dir</span><span class="p">,</span> <span class="s1">&#39;--log-file=sky.log </span><span class="se">\</span>
<span class="s1">                --log-level=debug muse_create_sky --fraction=&#39;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyfraction</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; --ignore=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyignore</span><span class="p">)</span>\
                <span class="o">+</span> <span class="s1">&#39; sky.sof&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyfield</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sky</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">skydate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">exp_list_SCI_sky</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">exps</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exp_list_SCI_sky</span><span class="p">):</span>
            <span class="n">skydate</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">exps</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
            <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_SKY_0001-01.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">exps</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)[</span><span class="n">sci</span><span class="p">]):</span>
            <span class="n">scidate</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">exps</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
            <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_OBJECT_0001-01.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">]</span>

            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">skydate</span> <span class="o">-</span> <span class="n">scidate</span><span class="p">))</span>
            <span class="n">flist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">exp_list_SCI_sky</span><span class="p">[</span><span class="n">ind</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/SKY_*.fits&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flist</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">exps</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="_modified_sky"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce._modified_sky">[docs]</a><span class="k">def</span> <span class="nf">_modified_sky</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This module calls *ESORex&#39;* ``muse_sky`` with the modified continuum and</span>
<span class="sd">    line subtraction as described in `Zeidler et al. 2019`_.</span>

<span class="sd">    Args:</span>
<span class="sd">        exp_list_SCI : :obj:`list`</span>
<span class="sd">            The list of all associated science files including their category</span>
<span class="sd">            read from the fits header</span>

<span class="sd">        create_sof : :obj:`bool`:</span>
<span class="sd">            :obj:`True`: ``bias.sof`` is created and populated</span>

<span class="sd">            :obj:`False`: ``bias.sof`` is not created and needs to be provided</span>
<span class="sd">            by the user</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... SKY CREATION MODIFIED&#39;</span><span class="p">)</span>

    <span class="n">sky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">sci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">exposure</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exposure</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SKY&#39;</span><span class="p">:</span>
            <span class="n">sky</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">exposure</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SCI&#39;</span><span class="p">:</span>
            <span class="n">sci</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyfield</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sky</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">exp_list_SCI_sky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)[</span><span class="n">sky</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exp_list_SCI_sky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">exposure_ID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI_sky</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing exposure: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exposure_ID</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>\
        <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI_sky</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing: &#39;</span> <span class="o">+</span> <span class="n">exp_list_SCI_sky</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="n">raw_data_list</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">exp_list_SCI_sky</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">],</span>\
        <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;no_header&#39;</span><span class="p">)</span>
        <span class="n">exposure_dir</span> <span class="o">=</span> <span class="n">exp_list_SCI_sky</span><span class="p">[</span><span class="n">exposure_ID</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyfield</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sky</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">PIXTABLE_SKY_list</span> <span class="o">=</span> <span class="n">_get_filelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exposure_dir</span><span class="p">,</span>\
            <span class="s1">&#39;PIXTABLE_SKY*.fits&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">PIXTABLE_SKY_list</span> <span class="o">=</span> <span class="n">_get_filelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exposure_dir</span><span class="p">,</span>\
            <span class="s1">&#39;PIXTABLE_OBJECT*.fits&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;sky.sof&#39;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;sky.sof&#39;</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;sky.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">PIXTABLE_SKY_list</span><span class="p">)):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">exposure_dir</span>\
                <span class="o">+</span> <span class="n">PIXTABLE_SKY_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; PIXTABLE_SKY</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ESO_calibration</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;SCIENCE/LSF_PROFILE.fits LSF_PROFILE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ESO_calibration</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;LSF_PROFILE.fits LSF_PROFILE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;std/&#39;</span> <span class="o">+</span> <span class="s1">&#39;STD_RESPONSE_0001.fits STD_RESPONSE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;std/&#39;</span> <span class="o">+</span> <span class="s1">&#39;STD_TELLURIC_0001.fits STD_TELLURIC</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;extinct_table.fits EXTINCT_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;sky_lines.fits SKY_LINES</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyfield</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sky</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exposure_dir</span><span class="p">,</span> <span class="s1">&#39;--log-file=sky.log&#39;</span>\
                <span class="o">+</span> <span class="s1">&#39;--log-level=debug muse_create_sky --fraction=&#39;</span>\
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyfraction</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; --ignore=&#39;</span>\
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyignore</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sky.sof&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exposure_dir</span><span class="p">,</span> <span class="s1">&#39;--log-file=sky.log&#39;</span>\
                <span class="o">+</span> <span class="s1">&#39;--log-level=debug muse_create_sky --fraction=&#39;</span>\
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyfraction</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; --ignore=&#39;</span>\
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyignore</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sky.sof&#39;</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">exposure_dir</span><span class="p">)</span>
        <span class="n">sky_cont_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;SKY_CONTINUUM.fits&#39;</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sky_cont</span> <span class="o">=</span> <span class="n">sky_cont_hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sky_cont</span><span class="p">)):</span>
            <span class="n">sky_cont</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">sky_cont_hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">sky_cont</span>
        <span class="n">sky_cont_hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;SKY_CONTINUUM_zero.fits&#39;</span><span class="p">,</span>\
        <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;sky.sof&#39;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;sky.sof&#39;</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;sky.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">PIXTABLE_SKY_list</span><span class="p">)):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">exposure_dir</span> <span class="o">+</span> <span class="n">PIXTABLE_SKY_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>\
                <span class="o">+</span> <span class="s1">&#39; PIXTABLE_SKY</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ESO_calibration</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;SCIENCE/LSF_PROFILE.fits LSF_PROFILE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ESO_calibration</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;LSF_PROFILE.fits LSF_PROFILE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;std/&#39;</span> <span class="o">+</span> <span class="s1">&#39;STD_RESPONSE_0001.fits STD_RESPONSE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;std/&#39;</span> <span class="o">+</span> <span class="s1">&#39;STD_TELLURIC_0001.fits STD_TELLURIC</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">exposure_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;SKY_CONTINUUM_zero.fits SKY_CONTINUUM</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;extinct_table.fits EXTINCT_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
            <span class="o">+</span> <span class="s1">&#39;sky_lines.fits SKY_LINES</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyfield</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sky</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exposure_dir</span><span class="p">,</span> <span class="s1">&#39;--log-file=sky.log&#39;</span>\
                <span class="o">+</span> <span class="s1">&#39;--log-level=debug muse_create_sky&#39;</span>\
                <span class="o">+</span> <span class="s1">&#39;--fraction=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyfraction</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; --ignore=&#39;</span>\
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyignore</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; sky.sof&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exposure_dir</span><span class="p">,</span> <span class="s1">&#39;--log-file=sky.log&#39;</span>\
                <span class="o">+</span> <span class="s1">&#39;--log-level=debug muse_create_sky --fraction=&#39;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyfraction</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; --ignore=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">skyignore</span><span class="p">)</span>\
                <span class="o">+</span> <span class="s1">&#39; sky.sof&#39;</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">exposure_dir</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SKY_CONTINUUM_zero.fits ==&gt; SKY_CONTINUUM.fits&#39;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s1">&#39;SKY_CONTINUUM_zero.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;SKY_CONTINUUM.fits&#39;</span><span class="p">)</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;SKY_LINES.fits&#39;</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="n">lines_to_keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sky_line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> \
        <span class="k">if</span> <span class="p">(</span><span class="n">sky_line</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;O2&#39;</span> <span class="ow">or</span> <span class="n">sky_line</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;OH&#39;</span><span class="p">)]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">lines_to_keep</span><span class="p">]</span>

        <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;SKY_LINES.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">checksum</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyfield</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sky</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">skydate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">exp_list_SCI_sky</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">exps</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exp_list_SCI_sky</span><span class="p">):</span>
            <span class="n">skydate</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">exps</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
            <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_SKY_0001-01.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">exps</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)[</span><span class="n">sci</span><span class="p">]):</span>
            <span class="n">scidate</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">exps</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
            <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_OBJECT_0001-01.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;MJD-OBS&#39;</span><span class="p">]</span>

            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">skydate</span> <span class="o">-</span> <span class="n">scidate</span><span class="p">))</span>
            <span class="n">flist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">exp_list_SCI_sky</span><span class="p">[</span><span class="n">ind</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/SKY_*.fits&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flist</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">exps</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="_scipost"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce._scipost">[docs]</a><span class="k">def</span> <span class="nf">_scipost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">,</span> <span class="n">OB</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This module calls *ESORex&#39;* ``muse_scipost``</span>

<span class="sd">    Args:</span>
<span class="sd">        exp_list_SCI : :obj:`list`</span>
<span class="sd">            The list of all associated science files including their category</span>
<span class="sd">            read from the fits header</span>

<span class="sd">        create_sof : :obj:`bool`:</span>
<span class="sd">            :obj:`True`: ``bias.sof`` is created and populated</span>

<span class="sd">            :obj:`False`: ``bias.sof`` is not created and needs to be provided</span>
<span class="sd">            by the user</span>

<span class="sd">        OB : :obj:`str`:</span>
<span class="sd">            The specific ``OB`` to be reduced. </span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... SCIENCE POST-PROCESSING&#39;</span><span class="p">)</span>

    <span class="n">unique_pointings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">unique_tester</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>

    <span class="n">sci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">exposure</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exposure</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SCI&#39;</span><span class="p">:</span>
            <span class="n">sci</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">exp_list_SCI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)[</span><span class="n">sci</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">expnum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">unique_tester</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">expnum</span><span class="p">][:</span><span class="o">-</span><span class="mi">16</span><span class="p">])</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">unique_pointings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unique_pointings</span><span class="p">,</span>\
            <span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">expnum</span><span class="p">][:</span><span class="o">-</span><span class="mi">16</span><span class="p">])</span>
            <span class="n">unique_tester</span> <span class="o">=</span> <span class="n">unique_tester</span> <span class="o">+</span> <span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">expnum</span><span class="p">][:</span><span class="o">-</span><span class="mi">16</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">unique_pointing_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_pointings</span><span class="p">)):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing pointing: &#39;</span>
        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_pointing_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_pointings</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="n">unique_pointings_ID</span> <span class="o">=</span> <span class="n">unique_pointings</span><span class="p">[</span><span class="n">unique_pointing_num</span><span class="p">][</span><span class="o">-</span><span class="mi">18</span><span class="p">:]</span>
        <span class="n">sec</span> <span class="o">=</span> <span class="n">unique_pointings</span><span class="p">[</span><span class="n">unique_pointing_num</span><span class="p">]</span>
        <span class="n">exp_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">sec</span> <span class="o">+</span> <span class="s1">&#39;*SCI.list&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">exp_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list</span><span class="p">)):</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing exposure: &#39;</span>\
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

            <span class="n">PIXTABLE_OBJECT_list</span> <span class="o">=</span> <span class="n">_get_filelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">],</span>\
            <span class="s1">&#39;PIXTABLE_OBJECT*.fits&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/scipost.sof&#39;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/scipost.sof&#39;</span><span class="p">)</span>

                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/scipost.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">PIXTABLE_OBJECT_list</span><span class="p">)):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">PIXTABLE_OBJECT_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; PIXTABLE_OBJECT</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ESO_calibration</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_dir</span>\
                    <span class="o">+</span> <span class="s1">&#39;SCIENCE/LSF_PROFILE.fits LSF_PROFILE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">using_ESO_calibration</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ESO_calibration_dir</span>\
                    <span class="o">+</span> <span class="s1">&#39;LSF_PROFILE.fits LSF_PROFILE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;std/&#39;</span> <span class="o">+</span> <span class="s1">&#39;STD_RESPONSE_0001.fits STD_RESPONSE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;std/&#39;</span> <span class="o">+</span> <span class="s1">&#39;STD_TELLURIC_0001.fits STD_TELLURIC</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;SKY_LINES.fits SKY_LINES</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;SKY_CONTINUUM.fits SKY_CONTINUUM</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;WFM-AO&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;WFM-NOAO&#39;</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
                    <span class="o">+</span> <span class="s1">&#39;astrometry_wcs_wfm.fits ASTROMETRY_WCS</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;NFM-AO&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CURRENTLY NO ASTRONOMY_WCS_NFM AVAILABLE !!!!&quot;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;extinct_table.fits EXTINCT_TABLE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;filter_list.fits FILTER_LIST</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raman</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
                    <span class="o">+</span> <span class="s1">&#39;raman_lines.fits RAMAN_LINES</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;without sky ...&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raman</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                            <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">],</span>\
                            <span class="s1">&#39;--log-file=scipost.log --log-level=debug</span><span class="se">\</span>
<span class="s1">                            muse_scipost --save=cube,skymodel,individual,raman</span><span class="se">\</span>
<span class="s1">                            --skymethod=&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">skymethod</span><span class="o">+</span><span class="s1">&#39; </span><span class="se">\</span>
<span class="s1">                            --filter=white scipost.sof&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">raman</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                            <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">],</span>\
                            <span class="s1">&#39;--log-file=scipost.log --log-level=debug </span><span class="se">\</span>
<span class="s1">                            muse_scipost --save=cube,skymodel,individual </span><span class="se">\</span>
<span class="s1">                            --skymethod=&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">skymethod</span><span class="o">+</span><span class="s1">&#39; </span><span class="se">\</span>
<span class="s1">                            --filter=white scipost.sof&#39;</span><span class="p">)</span>

                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;DATACUBE_FINAL.fits&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;DATACUBE_FINAL_wosky.fits&#39;</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;IMAGE_FOV_0001.fits&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;IMAGE_FOV_0001_wosky.fits&#39;</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;PIXTABLE_REDUCED_0001.fits&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;PIXTABLE_REDUCED_0001_wosky.fits&#39;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;with sky ...&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raman</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                            <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">],</span>\
                            <span class="s1">&#39;--log-file=scipost.log --log-level=debug </span><span class="se">\</span>
<span class="s1">                            muse_scipost --save=cube,skymodel,individual,raman</span><span class="se">\</span>
<span class="s1">                            --skymethod=none --filter=white scipost.sof&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">raman</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                            <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">],</span>\
                            <span class="s1">&#39;--log-file=scipost.log --log-level=debug </span><span class="se">\</span>
<span class="s1">                            muse_scipost --save=cube,skymodel,individual </span><span class="se">\</span>
<span class="s1">                            --skymethod=none --filter=white scipost.sof&#39;</span><span class="p">)</span>

                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;DATACUBE_FINAL.fits&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;DATACUBE_FINAL_wsky.fits&#39;</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;IMAGE_FOV_0001.fits&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;IMAGE_FOV_0001_wsky.fits&#39;</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;PIXTABLE_REDUCED_0001.fits&#39;</span><span class="p">,</span>\
                        <span class="s1">&#39;PIXTABLE_REDUCED_0001_wsky.fits&#39;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raman</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">],</span>\
                        <span class="s1">&#39;--log-file=scipost.log --log-level=debug muse_scipost</span><span class="se">\</span>
<span class="s1">                        --save=cube,skymodel,individual,raman --skymethod=none</span><span class="se">\</span>
<span class="s1">                        --rvcorr=none --filter=white scipost.sof&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">raman</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">],</span>\
                        <span class="s1">&#39;--log-file=scipost.log --log-level=debug muse_scipost</span><span class="se">\</span>
<span class="s1">                        --save=cube,skymodel,individual --skymethod=none </span><span class="se">\</span>
<span class="s1">                        --rvcorr=none --filter=white scipost.sof&#39;</span><span class="p">)</span>

                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;DATACUBE_FINAL.fits&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;DATACUBE_FINAL_wskynorvcorr.fits&#39;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;IMAGE_FOV_0001.fits&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;IMAGE_FOV_0001_wskynorvcorr.fits&#39;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;PIXTABLE_REDUCED_0001.fits&#39;</span><span class="p">,</span>\
                    <span class="s1">&#39;PIXTABLE_REDUCED_0001_wskynorvcorr.fits&#39;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span><span class="p">)</span></div>


<div class="viewcode-block" id="_dither_collect"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce._dither_collect">[docs]</a><span class="k">def</span> <span class="nf">_dither_collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">OB</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This module collects the individual dither exposures for one OB to be</span>
<span class="sd">    combined in the steps: :mod:`MUSEreduce._exp_align` and</span>
<span class="sd">    :mod:`MUSEreduce._exp_combine`</span>

<span class="sd">    Args:</span>
<span class="sd">        exp_list_SCI : :obj:`list`</span>
<span class="sd">            The list of all associated science files including their category</span>
<span class="sd">            read from the fits header</span>

<span class="sd">        create_sof : :obj:`bool`:</span>
<span class="sd">            :obj:`True`: ``bias.sof`` is created and populated</span>

<span class="sd">            :obj:`False`: ``bias.sof`` is not created and needs to be provided</span>
<span class="sd">            by the user</span>

<span class="sd">        OB : :obj:`str`:</span>
<span class="sd">            The specific ``OB`` to be reduced.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... COLLECT DITHER POSTITIONS&#39;</span><span class="p">)</span>

    <span class="n">unique_pointings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">unique_tester</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>

    <span class="n">sci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">exposure</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exposure</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SCI&#39;</span><span class="p">:</span>
            <span class="n">sci</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">exp_list_SCI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)[</span><span class="n">sci</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; Copying files:&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">expnum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">unique_tester</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">expnum</span><span class="p">][:</span><span class="o">-</span><span class="mi">16</span><span class="p">])</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">unique_pointings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unique_pointings</span><span class="p">,</span>\
                    <span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">expnum</span><span class="p">][:</span><span class="o">-</span><span class="mi">16</span><span class="p">])</span>
                    <span class="n">unique_tester</span> <span class="o">=</span> <span class="n">unique_tester</span> <span class="o">+</span> <span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">expnum</span><span class="p">][:</span><span class="o">-</span><span class="mi">16</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">unique_pointings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span>\
        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">18</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">unique_pointing_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_pointings</span><span class="p">)):</span>
        <span class="n">unique_pointings_ID</span> <span class="o">=</span> <span class="n">unique_pointings</span><span class="p">[</span><span class="n">unique_pointing_num</span><span class="p">][</span><span class="o">-</span><span class="mi">18</span><span class="p">:]</span>
        <span class="n">sec</span> <span class="o">=</span> <span class="n">unique_pointings</span><span class="p">[</span><span class="n">unique_pointing_num</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">exp_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">sec</span> <span class="o">+</span> <span class="s1">&#39;*SCI.list&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">exp_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_list</span> <span class="o">+</span> <span class="s1">&#39;_SCI.list&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithering_multiple_OBs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span><span class="p">:</span>
                <span class="n">combining_exposure_dir_withoutsky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span>\
                <span class="o">+</span> <span class="n">unique_pointings_ID</span> <span class="o">+</span> <span class="s1">&#39;/withoutsky_withrvcorr&#39;</span>
                <span class="n">combining_exposure_dir_withsky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span>\
                <span class="o">+</span> <span class="n">unique_pointings_ID</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withrvcorr&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combining_exposure_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span>\
                <span class="o">+</span> <span class="n">unique_pointings_ID</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withoutrvcorr&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithering_multiple_OBs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span><span class="p">:</span>
                <span class="n">combining_exposure_dir_withoutsky</span> <span class="o">=</span>\
                <span class="n">sec</span> <span class="o">+</span> <span class="s1">&#39;/withoutsky_withrvcorr&#39;</span>
                <span class="n">combining_exposure_dir_withsky</span> <span class="o">=</span> <span class="n">sec</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withrvcorr&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combining_exposure_dir</span> <span class="o">=</span> <span class="n">sec</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withoutrvcorr&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">combining_exposure_dir_withoutsky</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">combining_exposure_dir_withoutsky</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">combining_exposure_dir_withsky</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">combining_exposure_dir_withsky</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">combining_exposure_dir_withoutsky</span>\
            <span class="o">+</span> <span class="s1">&#39;/*FOV_0001*&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">combining_exposure_dir_withsky</span> <span class="o">+</span> <span class="s1">&#39;/*FOV_0001*&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">combining_exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;/*FOV_0001*&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">unique_pointing_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_pointings</span><span class="p">)):</span>

        <span class="n">unique_pointings_ID</span> <span class="o">=</span> <span class="n">unique_pointings</span><span class="p">[</span><span class="n">unique_pointing_num</span><span class="p">][</span><span class="o">-</span><span class="mi">18</span><span class="p">:]</span>
        <span class="n">sec</span> <span class="o">=</span> <span class="n">unique_pointings</span><span class="p">[</span><span class="n">unique_pointing_num</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">exp_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">sec</span> <span class="o">+</span> <span class="s1">&#39;*SCI.list&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">exp_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_list</span> <span class="o">+</span> <span class="s1">&#39;_SCI.list&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithering_multiple_OBs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span><span class="p">:</span>
                <span class="n">combining_exposure_dir_withoutsky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span>\
                <span class="o">+</span> <span class="n">unique_pointings_ID</span> <span class="o">+</span> <span class="s1">&#39;/withoutsky_withrvcorr&#39;</span>
                <span class="n">combining_exposure_dir_withsky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span>\
                <span class="o">+</span> <span class="n">unique_pointings_ID</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withrvcorr&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combining_exposure_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span>\
                <span class="o">+</span> <span class="n">unique_pointings_ID</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withoutrvcorr&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithering_multiple_OBs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span><span class="p">:</span>
                <span class="n">combining_exposure_dir_withoutsky</span> <span class="o">=</span>\
                <span class="n">sec</span> <span class="o">+</span> <span class="s1">&#39;/withoutsky_withrvcorr&#39;</span>
                <span class="n">combining_exposure_dir_withsky</span> <span class="o">=</span> <span class="n">sec</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withrvcorr&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combining_exposure_dir</span> <span class="o">=</span> <span class="n">sec</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withoutrvcorr&#39;</span>

        <span class="k">for</span> <span class="n">exp_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithering_multiple_OBs</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_wosky.fits ==&gt; &#39;</span>\
                        <span class="o">+</span> <span class="n">combining_exposure_dir_withoutsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_&#39;</span> <span class="o">+</span> <span class="n">OB</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>\
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_wosky.fits&#39;</span><span class="p">,</span>\
                        <span class="n">combining_exposure_dir_withoutsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_&#39;</span> <span class="o">+</span> <span class="n">OB</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>\
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_0001_wosky.fits ==&gt; &#39;</span>\
                        <span class="o">+</span> <span class="n">combining_exposure_dir_withoutsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_&#39;</span> <span class="o">+</span> <span class="n">OB</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>\
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_0001_wosky.fits&#39;</span><span class="p">,</span>\
                        <span class="n">combining_exposure_dir_withoutsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_&#39;</span> <span class="o">+</span> <span class="n">OB</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>\
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_0001_wosky.fits ==&gt; &#39;</span>\
                        <span class="o">+</span> <span class="n">combining_exposure_dir_withoutsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_&#39;</span> <span class="o">+</span> <span class="n">OB</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>\
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_0001_wosky.fits&#39;</span><span class="p">,</span>\
                        <span class="n">combining_exposure_dir_withoutsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_&#39;</span> <span class="o">+</span> <span class="n">OB</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>\
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_wosky.fits ==&gt; &#39;</span>\
                        <span class="o">+</span> <span class="n">combining_exposure_dir_withoutsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_&#39;</span>\
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_wosky.fits&#39;</span><span class="p">,</span>\
                        <span class="n">combining_exposure_dir_withoutsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_&#39;</span>\
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_0001_wosky.fits ==&gt; &#39;</span>\
                        <span class="o">+</span> <span class="n">combining_exposure_dir_withoutsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>\
                        <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_0001_wosky.fits&#39;</span><span class="p">,</span>\
                        <span class="n">combining_exposure_dir_withoutsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>\
                        <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_0001_wosky.fits ==&gt; &#39;</span>\
                        <span class="o">+</span> <span class="n">combining_exposure_dir_withoutsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_&#39;</span>\
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_0001_wosky.fits&#39;</span><span class="p">,</span>\
                        <span class="n">combining_exposure_dir_withoutsky</span> <span class="o">+</span>\
                        <span class="s1">&#39;/PIXTABLE_REDUCED_&#39;</span>\
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithering_multiple_OBs</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_wsky.fits ==&gt; &#39;</span>\
                        <span class="o">+</span> <span class="n">combining_exposure_dir_withsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_&#39;</span> <span class="o">+</span> <span class="n">OB</span>\
                        <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_wsky.fits&#39;</span><span class="p">,</span>\
                        <span class="n">combining_exposure_dir_withsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_&#39;</span> <span class="o">+</span> <span class="n">OB</span>\
                        <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_0001_wsky.fits ==&gt; &#39;</span>\
                        <span class="o">+</span> <span class="n">combining_exposure_dir_withsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_&#39;</span> <span class="o">+</span> <span class="n">OB</span>\
                        <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_0001_wsky.fits&#39;</span><span class="p">,</span>\
                        <span class="n">combining_exposure_dir_withsky</span> <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_&#39;</span> <span class="o">+</span> <span class="n">OB</span>\
                        <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span> <span class="o">+</span>\
                        <span class="s1">&#39; /PIXTABLE_REDUCED_0001_wsky.fits ==&gt; &#39;</span>\
                        <span class="o">+</span> <span class="n">combining_exposure_dir_withsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_&#39;</span> <span class="o">+</span> <span class="n">OB</span>\
                        <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_0001_wsky.fits&#39;</span><span class="p">,</span>\
                        <span class="n">combining_exposure_dir_withsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_&#39;</span> <span class="o">+</span> <span class="n">OB</span>\
                        <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_wsky.fits ==&gt; &#39;</span>\
                        <span class="o">+</span> <span class="n">combining_exposure_dir_withsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>\
                        <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_wsky.fits&#39;</span><span class="p">,</span>\
                        <span class="n">combining_exposure_dir_withsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>\
                        <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_0001_wsky.fits ==&gt; &#39;</span>\
                        <span class="o">+</span> <span class="n">combining_exposure_dir_withsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>\
                        <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_0001_wsky.fits&#39;</span><span class="p">,</span>\
                        <span class="n">combining_exposure_dir_withsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>\
                        <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_0001_wsky.fits ==&gt; &#39;</span>\
                        <span class="o">+</span> <span class="n">combining_exposure_dir_withsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_&#39;</span>\
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                        <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_0001_wsky.fits&#39;</span><span class="p">,</span>\
                        <span class="n">combining_exposure_dir_withsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_&#39;</span>\
                        <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">dithering_multiple_OBs</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_wskynorvcorr.fits ==&gt; &#39;</span>\
                    <span class="o">+</span> <span class="n">combining_exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_&#39;</span> <span class="o">+</span> <span class="n">OB</span>\
                    <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_wskynorvcorr.fits&#39;</span><span class="p">,</span>\
                    <span class="n">combining_exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_&#39;</span> <span class="o">+</span> <span class="n">OB</span>\
                    <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_0001_wskynorvcorr.fits ==&gt; &#39;</span>\
                    <span class="o">+</span> <span class="n">combining_exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_&#39;</span> <span class="o">+</span> <span class="n">OB</span>\
                    <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_0001_wskynorvcorr.fits&#39;</span><span class="p">,</span>\
                    <span class="n">combining_exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_&#39;</span> <span class="o">+</span> <span class="n">OB</span>\
                    <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_0001_wskynorvcorr.fits ==&gt; &#39;</span>\
                    <span class="o">+</span> <span class="n">combining_exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_&#39;</span> <span class="o">+</span> <span class="n">OB</span>\
                    <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_0001_wskynorvcorr.fits&#39;</span><span class="p">,</span>\
                    <span class="n">combining_exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_&#39;</span> <span class="o">+</span> <span class="n">OB</span>\
                    <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_wskynorvcorr.fits ==&gt; &#39;</span>\
                    <span class="o">+</span> <span class="n">combining_exposure_dir</span>\
                    <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>\
                    <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_wskynorvcorr.fits&#39;</span><span class="p">,</span>\
                    <span class="n">combining_exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;/DATACUBE_FINAL_&#39;</span>\
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_0001_wskynorvcorr.fits ==&gt; &#39;</span>\
                    <span class="o">+</span> <span class="n">combining_exposure_dir</span>\
                    <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>\
                    <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_0001_wskynorvcorr.fits&#39;</span><span class="p">,</span>\
                    <span class="n">combining_exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;/IMAGE_FOV_&#39;</span>\
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_0001_wskynorvcorr.fits ==&gt; &#39;</span>\
                    <span class="o">+</span> <span class="n">combining_exposure_dir</span>\
                    <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>\
                    <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">exp_list</span><span class="p">[</span><span class="n">exp_num</span><span class="p">][:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>\
                    <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_0001_wskynorvcorr.fits&#39;</span><span class="p">,</span>\
                    <span class="n">combining_exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;/PIXTABLE_REDUCED_&#39;</span>\
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.fits&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="_exp_align"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce._exp_align">[docs]</a><span class="k">def</span> <span class="nf">_exp_align</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">,</span> <span class="n">OB</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This module calls *ESORex&#39;* ``muse_exp_align``</span>

<span class="sd">    Args:</span>
<span class="sd">        exp_list_SCI : :obj:`list`</span>
<span class="sd">            The list of all associated science files including their category</span>
<span class="sd">            read from the fits header</span>

<span class="sd">        create_sof : :obj:`bool`:</span>
<span class="sd">            :obj:`True`: ``bias.sof`` is created and populated</span>

<span class="sd">            :obj:`False`: ``bias.sof`` is not created and needs to be provided</span>
<span class="sd">            by the user</span>

<span class="sd">        OB : :obj:`str`:</span>
<span class="sd">            The specific ``OB`` to be reduced.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... CUBE ALIGNMENT&#39;</span><span class="p">)</span>

    <span class="n">esorex_cmd</span> <span class="o">=</span> <span class="s1">&#39;--log-file=exp_align.log --log-level=debug </span><span class="se">\</span>
<span class="s1">    muse_exp_align exp_align.sof&#39;</span>

    <span class="n">unique_pointings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">unique_tester</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>

    <span class="n">sci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">exposure</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exposure</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SCI&#39;</span><span class="p">:</span>
            <span class="n">sci</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">exp_list_SCI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)[</span><span class="n">sci</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">expnum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">unique_tester</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">expnum</span><span class="p">][:</span><span class="o">-</span><span class="mi">16</span><span class="p">])</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">unique_pointings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unique_pointings</span><span class="p">,</span>\
                    <span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">expnum</span><span class="p">][:</span><span class="o">-</span><span class="mi">16</span><span class="p">])</span>
                    <span class="n">unique_tester</span> <span class="o">=</span> <span class="n">unique_tester</span> <span class="o">+</span> <span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">expnum</span><span class="p">][:</span><span class="o">-</span><span class="mi">16</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">unique_pointings</span> <span class="o">=</span> <span class="n">unique_pointings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span>\
        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">18</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">unique_pointing_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_pointings</span><span class="p">)):</span>

        <span class="n">unique_pointings_ID</span> <span class="o">=</span> <span class="n">unique_pointings</span><span class="p">[</span><span class="n">unique_pointing_num</span><span class="p">][</span><span class="o">-</span><span class="mi">18</span><span class="p">:]</span>
        <span class="n">sec</span> <span class="o">=</span> <span class="n">unique_pointings</span><span class="p">[</span><span class="n">unique_pointing_num</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">exp_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">sec</span> <span class="o">+</span> <span class="s1">&#39;*SCI.list&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">exp_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_list</span> <span class="o">+</span> <span class="s1">&#39;_SCI.list&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithering_multiple_OBs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span><span class="p">:</span>
                <span class="n">combining_exposure_dir_withoutsky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span>\
                <span class="o">+</span> <span class="n">unique_pointings_ID</span> <span class="o">+</span> <span class="s1">&#39;/withoutsky_withrvcorr&#39;</span>
                <span class="n">combining_exposure_dir_withsky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span>\
                <span class="o">+</span> <span class="n">unique_pointings_ID</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withrvcorr&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combining_exposure_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span>\
                <span class="o">+</span> <span class="n">unique_pointings_ID</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withoutrvcorr&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithering_multiple_OBs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span><span class="p">:</span>
                <span class="n">combining_exposure_dir_withoutsky</span> <span class="o">=</span> <span class="n">sec</span>\
                <span class="o">+</span> <span class="s1">&#39;/withoutsky_withrvcorr&#39;</span>
                <span class="n">combining_exposure_dir_withsky</span> <span class="o">=</span> <span class="n">sec</span>\
                <span class="o">+</span> <span class="s1">&#39;/withsky_withrvcorr&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combining_exposure_dir</span> <span class="o">=</span> <span class="n">sec</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withoutrvcorr&#39;</span>

    <span class="k">for</span> <span class="n">unique_pointing_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_pointings</span><span class="p">)):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing pointing: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_pointing_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>\
        <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_pointings</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="n">unique_pointings_ID</span> <span class="o">=</span> <span class="n">unique_pointings</span><span class="p">[</span><span class="n">unique_pointing_num</span><span class="p">][</span><span class="o">-</span><span class="mi">18</span><span class="p">:]</span>
        <span class="n">sec</span> <span class="o">=</span> <span class="n">unique_pointings</span><span class="p">[</span><span class="n">unique_pointing_num</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithering_multiple_OBs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">unique_pointings_ID</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span><span class="p">:</span>
                    <span class="n">combining_exposure_dir_withoutsky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span>\
                    <span class="o">+</span> <span class="n">unique_pointings_ID</span> <span class="o">+</span> <span class="s1">&#39;/withoutsky_withrvcorr&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span><span class="p">:</span>
                    <span class="n">combining_exposure_dir_withsky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span>\
                    <span class="o">+</span> <span class="n">unique_pointings_ID</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withrvcorr&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combining_exposure_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span>\
                <span class="o">+</span> <span class="n">unique_pointings_ID</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withoutrvcorr&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithering_multiple_OBs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span><span class="p">:</span>
                    <span class="n">combining_exposure_dir_withoutsky</span> <span class="o">=</span> <span class="n">sec</span>\
                    <span class="o">+</span> <span class="s1">&#39;/withoutsky_withrvcorr&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span><span class="p">:</span>
                    <span class="n">combining_exposure_dir_withsky</span> <span class="o">=</span> <span class="n">sec</span>\
                    <span class="o">+</span> <span class="s1">&#39;/withsky_withrvcorr&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combining_exposure_dir</span> <span class="o">=</span> <span class="n">sec</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withoutrvcorr&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span><span class="p">:</span>
                <span class="n">exp_list</span> <span class="o">=</span> <span class="n">_get_filelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>\
                <span class="n">combining_exposure_dir_withoutsky</span><span class="p">,</span> <span class="s1">&#39;IMAGE_FOV_*.fits&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">combining_exposure_dir_withoutsky</span>\
                    <span class="o">+</span> <span class="s1">&#39;/exp_align.sof&#39;</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">combining_exposure_dir_withoutsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/exp_align.sof&#39;</span><span class="p">)</span>

                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">combining_exposure_dir_withoutsky</span>\
                    <span class="o">+</span> <span class="s1">&#39;/exp_align.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list</span><span class="p">)):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">combining_exposure_dir_withoutsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">exp_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; IMAGE_FOV</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combining_exposure_dir_withoutsky</span><span class="p">,</span>\
                    <span class="n">esorex_cmd</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span><span class="p">:</span>
                <span class="n">exp_list</span> <span class="o">=</span> <span class="n">_get_filelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>\
                <span class="n">combining_exposure_dir_withsky</span><span class="p">,</span> <span class="s1">&#39;IMAGE_FOV_*.fits&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">combining_exposure_dir_withsky</span>\
                    <span class="o">+</span> <span class="s1">&#39;/exp_align.sof&#39;</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">combining_exposure_dir_withsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/exp_align.sof&#39;</span><span class="p">)</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">combining_exposure_dir_withsky</span>\
                    <span class="o">+</span> <span class="s1">&#39;/exp_align.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list</span><span class="p">)):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">combining_exposure_dir_withsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">exp_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; IMAGE_FOV</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combining_exposure_dir_withsky</span><span class="p">,</span>\
                    <span class="n">esorex_cmd</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">exp_list</span> <span class="o">=</span> <span class="n">_get_filelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>\
            <span class="n">combining_exposure_dir</span><span class="p">,</span> <span class="s1">&#39;IMAGE_FOV_*.fits&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">combining_exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;/exp_align.sof&#39;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">combining_exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;/exp_align.sof&#39;</span><span class="p">)</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">combining_exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;/exp_align.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list</span><span class="p">)):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">combining_exposure_dir</span>\
                    <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">exp_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; IMAGE_FOV</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combining_exposure_dir</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">)</span></div>


<div class="viewcode-block" id="_exp_combine"><a class="viewcode-back" href="../MUSEreduce.html#MUSEreduce._exp_combine">[docs]</a><span class="k">def</span> <span class="nf">_exp_combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">create_sof</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This module calls *ESORex&#39;* ``muse_exp_combine``</span>

<span class="sd">    Args:</span>
<span class="sd">        exp_list_SCI : :obj:`list`</span>
<span class="sd">            The list of all associated science files including their category</span>
<span class="sd">            read from the fits header</span>

<span class="sd">        create_sof : :obj:`bool`:</span>
<span class="sd">            :obj:`True`: ``bias.sof`` is created and populated</span>

<span class="sd">            :obj:`False`: ``bias.sof`` is not created and needs to be provided</span>
<span class="sd">            by the user</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;... EXPOSURE COMBINATION&#39;</span><span class="p">)</span>

    <span class="n">esorex_cmd</span> <span class="o">=</span> <span class="s1">&#39;--log-file=exp_combine.log --log-level=debug </span><span class="se">\</span>
<span class="s1">    muse_exp_combine --filter=white --save=cube --crsigma=5. </span><span class="se">\</span>
<span class="s1">    --weight=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; exp_combine.sof&#39;</span>

    <span class="n">unique_pointings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">unique_tester</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>

    <span class="n">sci</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">exposure</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exposure</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SCI&#39;</span><span class="p">:</span>
            <span class="n">sci</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">exp_list_SCI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)[</span><span class="n">sci</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">expnum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">unique_tester</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">expnum</span><span class="p">][:</span><span class="o">-</span><span class="mi">16</span><span class="p">])</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">unique_pointings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unique_pointings</span><span class="p">,</span>\
                    <span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">expnum</span><span class="p">][:</span><span class="o">-</span><span class="mi">16</span><span class="p">])</span>
                    <span class="n">unique_tester</span> <span class="o">=</span> <span class="n">unique_tester</span> <span class="o">+</span> <span class="n">exp_list_SCI</span><span class="p">[</span><span class="n">expnum</span><span class="p">][:</span><span class="o">-</span><span class="mi">16</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">unique_pointings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_dir</span>\
        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">user_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">18</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">unique_pointing_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_pointings</span><span class="p">)):</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; processing pointing: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">unique_pointing_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>\
        <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_pointings</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="n">unique_pointings_ID</span> <span class="o">=</span> <span class="n">unique_pointings</span><span class="p">[</span><span class="n">unique_pointing_num</span><span class="p">][</span><span class="o">-</span><span class="mi">18</span><span class="p">:]</span>
        <span class="n">sec</span> <span class="o">=</span> <span class="n">unique_pointings</span><span class="p">[</span><span class="n">unique_pointing_num</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithering_multiple_OBs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span><span class="p">:</span>
                    <span class="n">combining_exposure_dir_withoutsky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span>\
                    <span class="o">+</span> <span class="n">unique_pointings_ID</span> <span class="o">+</span> <span class="s1">&#39;/withoutsky_withrvcorr&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span><span class="p">:</span>
                    <span class="n">combining_exposure_dir_withsky</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span>\
                    <span class="o">+</span> <span class="n">unique_pointings_ID</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withrvcorr&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combining_exposure_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_OBs_dir</span>\
                <span class="o">+</span> <span class="n">unique_pointings_ID</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withoutrvcorr&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dithering_multiple_OBs</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span><span class="p">:</span>
                    <span class="n">combining_exposure_dir_withoutsky</span> <span class="o">=</span>\
                    <span class="n">sec</span> <span class="o">+</span> <span class="s1">&#39;/withoutsky_withrvcorr&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span><span class="p">:</span>
                    <span class="n">combining_exposure_dir_withsky</span> <span class="o">=</span>\
                    <span class="n">sec</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withrvcorr&#39;</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">combining_exposure_dir</span> <span class="o">=</span> <span class="n">sec</span> <span class="o">+</span> <span class="s1">&#39;/withsky_withoutrvcorr&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">withrvcorr</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span><span class="p">:</span>
                <span class="n">pixtable_list</span> <span class="o">=</span> <span class="n">_get_filelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>\
                <span class="n">combining_exposure_dir_withoutsky</span><span class="p">,</span> <span class="s1">&#39;PIXTABLE_REDUCED_*.fits&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">combining_exposure_dir_withoutsky</span>\
                    <span class="o">+</span> <span class="s1">&#39;/exp_combine.sof&#39;</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">combining_exposure_dir_withoutsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/exp_combine.sof&#39;</span><span class="p">)</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">combining_exposure_dir_withoutsky</span>\
                    <span class="o">+</span> <span class="s1">&#39;/exp_combine.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pixtable_list</span><span class="p">)):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">combining_exposure_dir_withoutsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">pixtable_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; PIXTABLE_REDUCED</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">combining_exposure_dir_withoutsky</span>\
                    <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;OFFSET_LIST.fits OFFSET_LIST</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
                    <span class="o">+</span> <span class="s1">&#39;filter_list.fits FILTER_LIST</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combining_exposure_dir_withoutsky</span><span class="p">,</span>\
                    <span class="n">esorex_cmd</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub</span><span class="p">:</span>
                <span class="n">pixtable_list</span> <span class="o">=</span> <span class="n">_get_filelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>\
                <span class="n">combining_exposure_dir_withsky</span><span class="p">,</span> <span class="s1">&#39;PIXTABLE_REDUCED_*.fits&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">combining_exposure_dir_withsky</span>\
                    <span class="o">+</span> <span class="s1">&#39;/exp_combine.sof&#39;</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">combining_exposure_dir_withsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/exp_combine.sof&#39;</span><span class="p">)</span>

                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">combining_exposure_dir_withsky</span>\
                    <span class="o">+</span> <span class="s1">&#39;/exp_combine.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pixtable_list</span><span class="p">)):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">combining_exposure_dir_withsky</span>\
                        <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">pixtable_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; PIXTABLE_REDUCED</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">combining_exposure_dir_withsky</span>\
                    <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;OFFSET_LIST.fits OFFSET_LIST</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
                    <span class="o">+</span> <span class="s1">&#39;filter_list.fits FILTER_LIST</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combining_exposure_dir_withsky</span><span class="p">,</span>\
                    <span class="n">esorex_cmd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pixtable_list</span> <span class="o">=</span> <span class="n">_get_filelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>\
            <span class="n">combining_exposure_dir</span><span class="p">,</span> <span class="s1">&#39;PIXTABLE_REDUCED_*.fits&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">create_sof</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">combining_exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;/exp_combine.sof&#39;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">combining_exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;/exp_combine.sof&#39;</span><span class="p">)</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">combining_exposure_dir</span> <span class="o">+</span> <span class="s1">&#39;/exp_combine.sof&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pixtable_list</span><span class="p">)):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">combining_exposure_dir</span>\
                    <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">pixtable_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; PIXTABLE_REDUCED</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">combining_exposure_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;OFFSET_LIST.fits OFFSET_LIST</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_calibration_dir</span>\
                <span class="o">+</span> <span class="s1">&#39;filter_list.fits FILTER_LIST</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="n">_call_esorex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combining_exposure_dir</span><span class="p">,</span> <span class="n">esorex_cmd</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Peter Zeidler

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXXXX-1', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>